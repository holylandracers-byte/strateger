<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Strateger - Race Strategy Manager</title>
    
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect fill='%2322d3ee' width='100' height='100' rx='15'/><text x='50' y='70' text-anchor='middle' font-size='60' fill='black' font-weight='bold'>S</text></svg>">

    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://apis.google.com/js/api.js" async defer></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://bernardo-castilho.github.io/DragDropTouch/DragDropTouch.js"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

    <script src="js/racefacer-scraper.js"></script>
    <script src="js/apex-scraper.js"></script>
    <script src="js/live-timing-manager.js"></script>

    <link rel="stylesheet" href="css/style.css">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        navy: { 950: '#020617', 900: '#0f172a', 800: '#1e293b', 700: '#334155' },
                        ice: '#22d3ee', neon: '#a3e635', danger: '#ef4444', fuel: '#f97316',
                        squadA: '#3b82f6', squadB: '#06b6d4', live: '#ef4444',
                        gold: '#fbbf24', silver: '#9ca3af', bronze: '#f97316'
                    },
                    animation: { 
                        'pulse-fast': 'pulse 1s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'flash': 'flash 0.5s ease-in-out'
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-navy-950 text-gray-200 h-screen flex flex-col overflow-hidden">
    <header class="bg-navy-900 border-b border-gray-800 p-2 flex justify-between items-center shadow-md sticky top-0 z-20">
        <div class="flex items-center gap-2">
            <select id="langSelect" onchange="window.setLanguage(this.value)" 
                    class="text-xs bg-navy-800 px-1 py-0.5 rounded border border-gray-700 text-white cursor-pointer w-12">
                <option value="en">EN</option>
                <option value="he">HE</option>
                <option value="fr">FR</option>
                <option value="pt">PT</option>
            </select>

            <div class="text-lg font-bold tracking-widest text-white ml-2 hidden sm:block">
                STRAT<span class="text-ice">EGER</span>
            </div>
            
            <div id="googleAuthCompact" class="flex items-center ml-2">
                <button id="googleSignInBtn" onclick="window.googleSignIn()" class="flex items-center gap-2 bg-white text-gray-700 hover:bg-gray-100 border border-gray-300 px-2 py-1 rounded text-[10px] font-bold transition">
                    <img src="https://www.google.com/favicon.ico" class="w-3 h-3">
                    Login
                </button>

                <div id="googleUserDisplay" class="hidden flex items-center gap-2 bg-navy-800 border border-gray-600 px-2 py-1 rounded-full">
                    <img id="googleAvatarSmall" src="" class="w-4 h-4 rounded-full border border-ice">
                    <span id="googleNameSmall" class="text-xs text-white max-w-[80px] truncate hidden sm:block">User</span>
                    <button onclick="window.googleSignOut()" class="text-gray-400 hover:text-red-400 ml-1">
                        <i class="fas fa-sign-out-alt text-xs"></i>
                    </button>
                </div>
            </div>
        </div>

        <div class="flex items-center gap-2">
            <div id="syncControls" class="hidden flex items-center gap-1 bg-navy-800 px-2 py-1 rounded border border-gray-700">
                <span id="syncDot" class="sync-dot bg-green-500"></span>
                <span id="syncText" class="text-[10px] text-gray-400" data-i18n="synced">Synced</span>
            </div>
            
            <div id="liveIndicator" class="hidden sync-dot live-dot"></div>

            <button id="shareRaceBtn" onclick="window.copyInviteLink()" class="hidden bg-gradient-to-r from-ice to-blue-500 hover:from-blue-400 hover:to-ice text-navy-950 text-xs font-bold px-3 py-1.5 rounded-full shadow-lg transition transform active:scale-95 flex items-center gap-1">
                <i class="fas fa-link"></i>
                <span class="hidden sm:inline">Invite</span>
            </button>
            
            <span id="myHostId" class="hidden">---</span>
            <span id="dashboardHostId" class="hidden">---</span>
        </div>
    </header>

    <div id="setupScreen" class="flex-1 overflow-y-auto w-full bg-navy-950 relative p-2">
        
        <div class="max-w-lg mx-auto p-4 pb-24">
            <div id="googleActionsBar" class="hidden grid grid-cols-4 gap-2 mb-4">
                <button onclick="window.showTeamEmailModal()" class="bg-navy-800 border border-gray-700 hover:border-ice p-2 rounded flex flex-col items-center gap-1 group">
                    <i class="fas fa-envelope text-ice group-hover:scale-110 transition"></i>
                    <span class="text-[9px] text-gray-400">Email</span>
                </button>
                <button onclick="window.showCalendarModal()" class="bg-navy-800 border border-gray-700 hover:border-neon p-2 rounded flex flex-col items-center gap-1 group">
                    <i class="fas fa-calendar-plus text-neon group-hover:scale-110 transition"></i>
                    <span class="text-[9px] text-gray-400">Calendar</span>
                </button>
                <button onclick="window.loadStrategyLibrary()" class="bg-navy-800 border border-gray-700 hover:border-gold p-2 rounded flex flex-col items-center gap-1 group">
                    <i class="fas fa-book text-gold group-hover:scale-110 transition"></i>
                    <span class="text-[9px] text-gray-400">Library</span>
                </button>
                <button onclick="window.checkTeamAvailability()" class="bg-navy-800 border border-gray-700 hover:border-purple-400 p-2 rounded flex flex-col items-center gap-1 group">
                    <i class="fas fa-clock text-purple-400 group-hover:scale-110 transition"></i>
                    <span class="text-[9px] text-gray-400">Check</span>
                </button>
            </div> 
        </div>

        <div id="configPanel" class="space-y-3 transition-opacity duration-300">
            
            <div class="bg-gradient-to-r from-red-900/30 to-navy-800 p-3 rounded-lg border border-red-500/50">
                <div class="flex items-center gap-2 mb-2">
                    <span class="sync-dot live-dot"></span>
                    <span class="text-sm font-bold text-white" data-i18n="liveTiming">Live Timing</span>
                </div>
                <div class="space-y-2">
                    <input type="url" id="liveTimingUrl" placeholder="Live Timing URL..." class="input-field text-xs">
                    
                    <div>
                        <label class="text-[10px] text-gray-400 mb-1 block" data-i18n="searchBy">Search by:</label>
                        <div class="grid grid-cols-3 gap-1 mb-2">
                            <label class="flex items-center justify-center gap-1 bg-navy-950 p-2 rounded border border-gray-600 cursor-pointer has-[:checked]:border-ice has-[:checked]:bg-ice/20">
                                <input type="radio" name="searchType" value="team" checked class="hidden">
                                <span class="text-[10px] text-gray-300" data-i18n="team">Team</span>
                            </label>
                            <label class="flex items-center justify-center gap-1 bg-navy-950 p-2 rounded border border-gray-600 cursor-pointer has-[:checked]:border-ice has-[:checked]:bg-ice/20">
                                <input type="radio" name="searchType" value="kart" class="hidden">
                                <span class="text-[10px] text-gray-300" data-i18n="kart">Kart</span>
                            </label>
                            <label class="flex items-center justify-center gap-1 bg-navy-950 p-2 rounded border border-gray-600 cursor-pointer has-[:checked]:border-ice has-[:checked]:bg-ice/20">
                                <input type="radio" name="searchType" value="driver" class="hidden">
                                <span class="text-[10px] text-gray-300" data-i18n="driver">Driver</span>
                            </label>
                        </div>
                        <input type="text" id="searchValue" placeholder="Enter name..." class="input-field text-xs">
                    </div>

                    <div class="flex gap-2">
                        <button onclick="window.testLiveTiming()" class="flex-1 bg-red-900/50 border border-red-500/50 text-red-300 text-xs py-1.5 rounded hover:bg-red-900">Test</button>
                        <button onclick="window.startDemoMode()" class="flex-1 bg-neon/20 border border-neon/50 text-neon text-xs py-1.5 rounded hover:bg-neon/30">Demo</button>
                        <button onclick="window.openManualInput()" class="flex-1 bg-fuel/20 border border-fuel/50 text-fuel text-xs py-1.5 rounded hover:bg-fuel/30">Manual</button>
                    </div>
                    <div id="liveTimingStatus" class="text-[10px] text-gray-500 text-center"></div>
                </div>
            </div>

            <div id="simResult" class="bg-black/40 border border-ice/30 p-3 rounded text-xs text-ice font-mono text-center whitespace-pre-line hidden">
                calculating...
            </div>

            <div class="grid grid-cols-2 gap-3">
                <div>
                    <label class="label-text" data-i18n="duration">DURATION (H)</label>
                    <input type="number" id="raceDuration" value="24" oninput="window.runSim()" class="input-field text-lg font-bold">
                </div>
                <div>
                    <label class="label-text" data-i18n="reqStops">REQ STOPS</label>
                    <input type="number" id="reqPitStops" value="30" oninput="window.runSim()" class="input-field text-neon text-lg font-bold">
                </div>
            </div>

            <div class="grid grid-cols-2 gap-3">
                <div>
                    <label class="label-text" data-i18n="minStint">MIN STINT (M)</label>
                    <input type="number" id="minStint" value="10" oninput="window.runSim()" class="input-field">
                </div>
                <div>
                    <label class="label-text" data-i18n="maxStint">MAX STINT (M)</label>
                    <input type="number" id="maxStint" value="60" oninput="window.runSim()" class="input-field">
                </div>
            </div>
            
            <div class="bg-navy-800 p-2 rounded border border-gray-700 mt-2 space-y-3">
                <p class="text-[10px] text-gray-400 text-center font-bold uppercase" data-i18n="driverLimits">Advanced Constraints</p>
                
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="label-text text-red-400" data-i18n="pitClosedStart">üö´ Closed Start (min)</label>
                        <input type="number" id="pitClosedStart" value="0" oninput="window.runSim()" class="input-field border-red-900/50">
                    </div>
                    <div>
                        <label class="label-text text-red-400" data-i18n="pitClosedEnd">üö´ Closed End (min)</label>
                        <input type="number" id="pitClosedEnd" value="0" oninput="window.runSim()" class="input-field border-red-900/50">
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="label-text" data-i18n="minDrive">Min Driver Total</label>
                        <input type="number" id="minDriverTime" value="0" oninput="window.runSim()" class="input-field">
                    </div>
                    <div>
                        <label class="label-text" data-i18n="maxDrive">Max Driver Total</label>
                        <input type="number" id="maxDriverTime" value="0" oninput="window.runSim()" class="input-field">
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-3 pt-2 border-t border-gray-700">
                    <div>
                        <label class="label-text text-yellow-400 font-bold" data-i18n="releaseBuffer">Pit Alert / Buffer (s)</label>
                        <input type="number" id="releaseBuffer" value="0" oninput="window.runSim()" class="input-field border-yellow-600/50">
                    </div>
                    <div>
                        <label class="label-text text-gray-400 font-bold" data-i18n="pitTime">Pit Time (s)</label>
                        <input type="number" id="minPitTime" value="120" oninput="window.runSim()" class="input-field">
                    </div>
                </div>
                
                <div class="grid grid-cols-3 gap-2 pt-2">
                    <label class="flex items-center gap-2 cursor-pointer bg-navy-900 p-1 rounded border border-gray-600">
                        <input type="checkbox" id="allowDouble" onchange="window.runSim()" class="checkbox-field">
                        <span class="text-[10px] text-gray-300" data-i18n="doubleStint">Double</span>
                    </label>
                    <label class="flex items-center gap-2 cursor-pointer bg-navy-900 p-1 rounded border border-gray-600">
                        <input type="checkbox" id="trackFuel" onchange="window.toggleFuelInput(); window.runSim()" class="checkbox-field accent-fuel">
                        <span class="text-[10px] text-gray-300" data-i18n="fuel">Fuel</span>
                    </label>
                    <label class="flex items-center gap-2 cursor-pointer bg-navy-900 p-1 rounded border border-gray-600">
                        <input type="checkbox" id="useSquads" onchange="window.toggleSquadsInput(); window.runSim()" class="checkbox-field accent-squadB">
                        <span class="text-[10px] text-gray-300" data-i18n="squads">Squads</span>
                    </label>
                </div>
                
                <div id="fuelInputDiv" class="hidden mt-2 pt-2 border-t border-gray-700">
                    <label class="label-text text-fuel font-bold" data-i18n="fuelTankTime">Fuel Tank Limit (min)</label>
                    <input type="number" id="fuelTime" value="60" oninput="window.runSim()" class="input-field border-fuel/50">
                </div>
            </div>

            <div class="pt-2">
                <div class="flex justify-between items-center mb-1">
                    <label class="text-xs text-gray-400 font-bold" data-i18n="driversSetup">DRIVERS (Check Starter)</label>
                    <div class="space-x-1">
                        <button onclick="window.addDriverField(); window.runSim()" class="text-xs bg-navy-700 px-2 py-1 rounded hover:bg-navy-600 text-white font-bold">+</button>
                        <button onclick="window.removeDriverField(); window.runSim()" class="text-xs bg-navy-700 px-2 py-1 rounded hover:bg-navy-600 text-white font-bold">-</button>
                    </div>
                </div>
                <div id="driversList" class="space-y-2"></div>
            </div>
            
            <div id="actionButtons" class="mt-4 space-y-2">
                <button onclick="window.callAIStrategy(this)" class="w-full bg-indigo-900/50 hover:bg-indigo-800 border border-indigo-500/30 text-indigo-200 text-xs py-2 rounded transition">
                    ‚ú® Ask AI to Optimize (Server)
                </button>

                <button onclick="window.generatePreview(false, true)" class="w-full bg-gradient-to-r from-purple-600 to-fuchsia-600 hover:from-purple-500 hover:to-fuchsia-500 text-white font-bold py-3 rounded shadow-lg transition">
                    <i class="fas fa-chart-bar mr-2"></i> <span data-i18n="previewStrategy">Preview Strategy</span>
                </button>

                <button id="startRaceBtn" onclick="window.initRace()" class="w-full bg-ice hover:bg-cyan-300 text-navy-950 font-bold py-4 rounded text-xl shadow-[0_0_15px_rgba(34,211,238,0.4)] transition uppercase tracking-wider" data-i18n="startRace">
                    Start Race
                </button>
            </div>
        </div>
    </div>

    <div id="previewScreen" class="hidden fixed inset-0 bg-navy-950 z-50 overflow-y-auto p-4">
        <div class="max-w-4xl mx-auto">
            <div class="simulation-preview bg-navy-900 border-2 border-ice rounded-xl p-4">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-2xl font-bold text-ice">
                        <i class="fas fa-chart-gantt mr-2"></i> <span data-i18n="racePreview">Preview</span>
                    </h2>
                    <button onclick="window.closePreview()" class="text-gray-400 hover:text-white text-2xl">&times;</button>
                </div>
                
                <div class="bg-navy-800 rounded-lg p-3 mb-4 flex justify-between items-center">
                    <div>
                        <label class="block text-[10px] text-gray-400 uppercase font-bold mb-1" data-i18n="raceStartTime">Start Time</label>
                        <input type="time" id="raceStartTime" class="bg-navy-950 border border-gray-600 rounded px-2 py-1 text-white text-sm" onchange="window.recalculateTimelineTimes(); window.renderPreview()">
                    </div>
                    <div class="text-right text-xs text-gray-400">
                        <div>Start: <span id="timelineStart" class="text-white font-mono">--:--</span></div>
                        <div>End: <span id="timelineEnd" class="text-white font-mono">--:--</span></div>
                    </div>
                </div>
    
                <div id="driverScheduleList" class="space-y-3 mb-4"></div>
                
                <div id="strategySummary" class="grid grid-cols-2 sm:grid-cols-4 gap-3 mb-4"></div>
                
                <div class="flex gap-3">
                    <button onclick="window.closePreview()" class="flex-1 bg-navy-700 hover:bg-navy-600 text-white font-bold py-3 rounded">Edit</button>
                    <button onclick="window.saveStrategy()" class="flex-1 bg-gold/20 hover:bg-gold/30 text-gold font-bold py-3 rounded border border-gold/50">Save</button>
                    <button onclick="window.initRace()" class="flex-1 bg-gradient-to-r from-neon to-green-400 text-black font-bold py-3 rounded shadow-lg">Start Race</button>
                </div>
            </div>
        </div>
    </div>

    <div id="raceDashboard" class="hidden flex-1 flex flex-col min-h-0 bg-navy-950 w-full relative">
        <div class="bg-navy-900 border-b border-gray-800 shrink-0 p-2 flex justify-between items-center">
            <button id="btnRain" onclick="window.toggleRain()" class="bg-navy-800 border border-blue-500/50 rounded px-3 py-1 hover:bg-navy-700">
                <span id="rainIcon">‚òÄÔ∏è</span> <span id="rainText" class="text-xs font-bold text-yellow-400">Dry</span>
            </button>
            <div class="text-center">
                <div class="text-[10px] text-gray-500 uppercase">Race Time</div>
                <div id="raceTimerDisplay" class="text-xl font-mono font-bold text-white">00:00:00</div>
            </div>
            <div class="text-center">
                <div class="text-[10px] text-gray-500 uppercase">Stops</div>
                <div id="pitCountDisplay" class="text-base font-bold"><span class="text-neon">0</span>/<span>0</span></div>
            </div>
        </div>

        <div id="liveTimingPanel" class="hidden bg-navy-900/80 border-b border-red-500/50 p-2 shrink-0">
            <div class="flex justify-between items-center mb-1">
                <div class="flex items-center gap-2"><span class="sync-dot live-dot"></span> <span class="text-xs font-bold">LIVE</span></div>
                <button onclick="window.stopLiveTiming()" class="text-[10px] bg-red-900 text-white px-2 rounded">Stop</button>
            </div>
            <div class="grid grid-cols-3 gap-1 text-center">
                <div class="bg-navy-950 rounded border border-gray-700 p-1">
                    <div class="text-[9px] text-gray-500">POS</div>
                    <div id="livePosition" class="text-lg font-bold text-ice">-</div>
                </div>
                <div class="bg-navy-950 rounded border border-gray-700 p-1">
                    <div class="text-[9px] text-gray-500">LAST</div>
                    <div id="liveLastLap" class="text-sm font-mono">-</div>
                </div>
                <div class="bg-navy-950 rounded border border-gray-700 p-1">
                    <div class="text-[9px] text-gray-500">BEST</div>
                    <div id="liveBestLap" class="text-sm font-mono text-neon">-</div>
                </div>
            </div>
            <div id="competitorsTable" class="mt-1 bg-navy-950 rounded border border-gray-700 p-1 max-h-[100px] overflow-y-auto text-[10px]"></div>
        </div>
        
        <div id="liveTimingEmbed" class="hidden flex-1 bg-white relative">
            <button onclick="window.closeLiveTimingEmbed()" class="absolute top-0 right-0 bg-red-500 text-white px-2">X</button>
            <iframe id="liveTimingIframe" class="w-full h-full border-0"></iframe>
        </div>

        <div id="strategyBox" class="p-2 text-center bg-navy-900 border-b-2 border-neon shrink-0">
            <div class="text-[10px] text-gray-400">TARGET STINT</div>
            <div class="flex justify-center items-baseline gap-2">
                <span id="strategyTargetStint" class="text-2xl font-bold text-white">--:--</span>
                <span id="strategyDelta" class="text-sm font-bold text-gray-400">--</span>
            </div>
            <div id="strategyAdvice" class="text-[10px] text-gray-500">Build Time</div>
        </div>

        <div class="p-3 bg-navy-950 border-b border-gray-800 shrink-0">
            <div class="flex justify-between items-center mb-1">
                <div class="text-center w-1/2">
                    <div class="text-[10px] text-gray-500">CURRENT</div>
                    <div id="currentDriverName" class="text-lg font-bold text-ice truncate">---</div>
                </div>
                <div class="text-center w-1/2">
                    <div class="text-[10px] text-gray-500">STINT TIME</div>
                    <div id="stintTimerDisplay" class="text-3xl font-mono font-bold text-white">00:00</div>
                </div>
            </div>
           <div class="relative h-4 bg-navy-800 rounded-full overflow-hidden mt-1 border border-gray-700">
                <div id="zoneForbidden" class="absolute top-0 left-0 h-full bg-red-600/40 w-0 border-r border-red-500 z-0"></div>
                
                <div id="minStintLine" class="absolute top-0 bottom-0 w-0.5 bg-white/50 z-10 hidden"></div>

                <div id="stintProgressBar" class="absolute top-0 left-0 h-full bg-gradient-to-r from-green-600 to-neon transition-all duration-500 z-20 opacity-80 mix-blend-screen" style="width: 0%"></div>
                
                <div id="minStintText" class="absolute top-0 left-2 h-full flex items-center text-[9px] text-gray-400 font-bold z-30"></div>
            </div>
        </div>
        
        <div class="p-2 grid grid-cols-2 gap-2 shrink-0">
            <div id="activeSquadDisplay" class="hidden bg-navy-800 rounded p-1 text-center border border-gray-600">
                <span class="text-[10px] text-gray-400">ACTIVE SQUAD</span>
                <span id="activeSquadText" class="text-lg font-bold text-squadA">A</span>
            </div>
            <div class="col-span-2 grid grid-cols-2 gap-2">
                <button id="btnPush" onclick="window.setMode('push')" class="btn-press bg-navy-800 border border-green-900/50 rounded p-2 text-sm text-gray-300">üî• Push</button>
                <button id="btnBad" onclick="window.setMode('bad')" class="btn-press bg-navy-800 border border-red-900/50 rounded p-2 text-sm text-gray-300">üê¢ Problem</button>
            </div>
            <button id="btnResetMode" onclick="window.setMode('normal')" class="col-span-2 hidden bg-gray-700 text-xs py-1 rounded">Reset Mode</button>
        </div>

        <div class="flex-1 overflow-y-auto bg-navy-950 p-2 min-h-0">
            <table class="w-full text-sm">
                <thead class="text-gray-500 text-[10px] sticky top-0 bg-navy-950 z-10">
                    <tr><th class="text-left">DRIVER</th><th class="text-center">STINTS</th><th class="text-right">TOTAL</th></tr>
                </thead>
                <tbody id="statsTable"></tbody>
            </table>
        </div>

        <div class="bg-navy-900 border-t border-gray-800 p-3 shrink-0 space-y-3 pb-6">
            <div class="flex justify-between items-center">
                <div class="text-xs text-gray-400 flex flex-col">
                    <span data-i18n="nextDriver">NEXT</span>
                    <span id="nextDriverName" class="text-lg font-bold text-neon cursor-pointer hover:text-white transition" onclick="window.cycleNextDriver()">---</span>
                </div>

                <div class="flex items-center gap-2 bg-navy-800 p-1 rounded border border-gray-700">
                    <span class="text-[9px] text-gray-500 uppercase font-bold px-1" data-i18n="penalty">Adj</span>
                    
                    <div class="flex gap-1">
                        <button onclick="window.adjustPitTime(-5)" class="bg-green-900/40 hover:bg-green-800 text-green-400 border border-green-600/50 px-2 py-1 rounded text-xs font-bold transition">-5</button>
                        <button onclick="window.adjustPitTime(5)" class="bg-red-900/40 hover:bg-red-800 text-red-400 border border-red-600/50 px-2 py-1 rounded text-xs font-bold transition">+5</button>
                        <button onclick="window.adjustPitTime(10)" class="bg-red-900/40 hover:bg-red-800 text-red-400 border border-red-600/50 px-2 py-1 rounded text-xs font-bold transition">+10</button>
                    </div>

                    <div id="dashboardPitAdjDisplay" class="bg-navy-950 px-1.5 py-1 rounded text-ice font-mono font-bold text-xs min-w-[35px] text-center border border-gray-600">
                        0
                    </div>
                </div>
            </div>

            <button id="pitEntryBtn" onclick="window.confirmPitEntry()" class="w-full bg-danger hover:bg-red-600 text-white font-bold py-4 rounded-lg text-xl shadow-lg transition btn-press flex justify-between px-6 items-center">
                <span class="flex items-center gap-2">
                    <i class="fas fa-flag-checkered"></i> 
                    <span data-i18n="enterPit">ENTER PIT</span>
                </span>
                <span id="btnPitAdjBadge" class="hidden text-sm bg-black/30 px-2 py-1 rounded text-yellow-300 font-mono"></span>
            </button>
        </div>
    </div>

    <div id="pitModal" class="hidden fixed inset-0 bg-navy-950/95 z-50 flex flex-col items-center justify-center p-4">
        <h2 class="text-ice text-3xl font-bold mb-2 tracking-widest animate-pulse">IN PIT</h2>
        <p class="text-gray-400 mb-4">Next: <span id="modalNextDriverName" class="text-white font-bold text-xl">---</span></p>
        
        <div id="pitStintWarning" class="hidden bg-red-900/80 border border-red-500 text-white px-4 py-2 rounded mb-4 text-center animate-bounce">
            ‚ö†Ô∏è <span class="font-bold">SHORT STINT!</span> Penalty Risk
        </div>

        <div class="text-6xl font-bold font-mono text-white mb-2" id="pitTimerDisplay">00.0</div>
        
        <div id="modalPitAdjInfo" class="text-sm text-gray-500 mb-8 font-mono hidden">
            Includes <span id="modalPitAdjValue" class="text-white font-bold">0s</span> adjustment
        </div>
        
        <button id="notifyBtn" class="hidden w-full max-w-xs bg-fuel text-black font-bold py-3 rounded-lg text-lg mb-2">üì¢ Notify Driver</button>
        <div id="notifiedMsg" class="hidden text-fuel font-bold mb-4">‚úì Driver Notified</div>

        <button id="confirmExitBtn" disabled onclick="window.confirmPitExit()" class="w-full max-w-xs bg-gray-800 text-gray-500 font-bold py-4 rounded-lg text-2xl border border-gray-700 transition-all">Wait...</button>
        
        <button onclick="window.cancelPitStop()" class="text-red-400 mt-6 text-sm underline hover:text-red-300">Cancel Entry</button>
    </div>
    
    <div id="emailTeamModal" class="hidden fixed inset-0 bg-navy-950/95 z-50 flex items-center justify-center p-4">
        <div class="bg-navy-900 border border-gray-700 p-4 rounded w-full max-w-md">
            <h3 class="text-ice font-bold mb-2">Send Email</h3>
            <input type="text" id="emailRecipients" placeholder="Emails..." class="input-field mb-2">
            <input type="text" id="emailSubject" value="Race Strategy" class="input-field mb-2">
            <textarea id="emailMessage" class="input-field mb-2 h-20"></textarea>
            <label class="flex gap-2 text-xs text-gray-300 mb-2"><input type="checkbox" id="attachStrategy" checked> Attach Strategy</label>
            <div class="flex gap-2">
                <button onclick="window.sendTeamEmail()" class="flex-1 bg-ice text-navy-950 font-bold py-2 rounded">Send</button>
                <button onclick="window.closeEmailModal()" class="flex-1 bg-navy-700 text-gray-300 py-2 rounded">Cancel</button>
            </div>
        </div>
    </div>
    
    <div id="calendarModal" class="hidden fixed inset-0 bg-navy-950/95 z-50 flex items-center justify-center p-4">
        <div class="bg-navy-900 border border-gray-700 p-4 rounded w-full max-w-md">
            <h3 class="text-neon font-bold mb-2">Add to Calendar</h3>
            <input type="text" id="calendarTitle" placeholder="Title" class="input-field mb-2">
            <input type="date" id="calendarDate" class="input-field mb-2">
            <input type="time" id="calendarTime" class="input-field mb-2">
            <input type="text" id="calendarLocation" placeholder="Location" class="input-field mb-2">
            <div class="flex gap-2">
                <button onclick="window.createCalendarEvent()" class="flex-1 bg-neon text-navy-950 font-bold py-2 rounded">Create</button>
                <button onclick="window.closeCalendarModal()" class="flex-1 bg-navy-700 text-gray-300 py-2 rounded">Cancel</button>
            </div>
        </div>
    </div>

    <div id="saveStrategyModal" class="hidden fixed inset-0 bg-navy-950/95 z-50 flex items-center justify-center p-4">
        <div class="bg-navy-900 border border-gray-700 p-4 rounded w-full max-w-md">
            <h3 class="text-white font-bold mb-2">Save Strategy</h3>
            <input type="text" id="saveStrategyName" placeholder="Strategy Name" class="input-field mb-2">
            <div class="flex gap-4 mb-4 text-gray-300 text-xs">
                <label><input type="radio" name="strategyVisibility" value="private" checked> Private</label>
                <label><input type="radio" name="strategyVisibility" value="public"> Public</label>
            </div>
            <div class="flex gap-2">
                <button onclick="window.performStrategySave()" class="flex-1 bg-ice text-navy-950 font-bold py-2 rounded">Save</button>
                <button onclick="window.closeSaveStrategyModal()" class="flex-1 bg-navy-700 text-gray-300 py-2 rounded">Cancel</button>
            </div>
        </div>
    </div>
    
    <div id="strategyModal" class="hidden fixed inset-0 bg-navy-950/95 z-50 flex items-center justify-center p-4">
        <div class="bg-navy-900 border border-gray-700 rounded w-full max-w-lg max-h-[80vh] flex flex-col">
            <div class="p-3 border-b border-gray-700 flex justify-between items-center">
                <h3 class="text-ice font-bold">Saved Strategies</h3>
                <button onclick="window.closeStrategyModal()" class="text-gray-400">&times;</button>
            </div>
            <div id="strategyList" class="p-3 overflow-y-auto flex-1 text-xs space-y-2">Loading...</div>
        </div>
    </div>
    
    <div id="savedRaceModal" class="hidden fixed inset-0 bg-navy-950/98 z-50 flex items-center justify-center p-4">
        <div class="bg-navy-900 border-2 border-ice p-6 rounded-lg w-full max-w-sm text-center">
            <h2 class="text-xl font-bold text-ice mb-2">Active Race Found</h2>
            <div class="text-gray-400 text-sm mb-4">
                Driver: <span id="savedRaceDriver" class="text-white"></span><br>
                Remaining: <span id="savedRaceTime" class="text-neon"></span>
            </div>
            <button onclick="window.continueRace()" class="w-full bg-ice text-navy-950 font-bold py-3 rounded mb-2">Continue Race</button>
            <button onclick="window.confirmDiscardRace()" class="w-full bg-navy-800 text-gray-400 py-2 rounded">Discard</button>
        </div>
    </div>
    
    <div id="confirmDiscardModal" class="hidden fixed inset-0 bg-black/90 z-[60] flex items-center justify-center p-4">
        <div class="bg-red-900/20 border border-red-500 p-6 rounded w-full max-w-xs text-center">
            <h3 class="text-red-500 font-bold text-lg mb-2">Are you sure?</h3>
            <p class="text-gray-300 text-xs mb-4">This will delete the active race data permanently.</p>
            <div class="flex gap-2">
                <button onclick="window.finalDiscardRace()" class="flex-1 bg-red-600 text-white font-bold py-2 rounded">Yes, Delete</button>
                <button onclick="window.cancelDiscard()" class="flex-1 bg-navy-700 text-gray-300 py-2 rounded">No, Keep</button>
            </div>
        </div>
    </div>

    <div id="manualInputModal" class="hidden fixed inset-0 bg-navy-950/95 z-50 flex items-center justify-center p-4">
        <div class="bg-navy-900 border border-gray-700 p-4 rounded w-full max-w-xs">
            <h3 class="text-ice font-bold mb-3">Manual Input</h3>
            <div class="space-y-2">
                <input type="number" id="manualPosition" placeholder="Position" class="input-field">
                <input type="number" id="manualLaps" placeholder="Laps" class="input-field">
                <div class="flex gap-2">
                    <button onclick="window.applyManualInput()" class="flex-1 bg-ice text-navy-950 font-bold py-2 rounded">Apply</button>
                    <button onclick="window.closeManualInput()" class="flex-1 bg-navy-700 text-gray-300 py-2 rounded">Cancel</button>
                </div>
            </div>
        </div>
    </div>
    
    <div id="clientWaitScreen" class="hidden fixed inset-0 bg-navy-950 z-[100] flex flex-col items-center justify-center text-ice">
        <div class="text-3xl animate-pulse font-bold">Connecting to Race...</div>
        <div class="text-sm text-gray-500 mt-2">Waiting for host data</div>
    </div>

    <script src="js/state.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/network.js"></script>
    <script src="js/strategy.js"></script>
    <script src="js/live-timing.js"></script>
    <script src="js/ui.js"></script>
    <script src="js/main.js"></script>
</body>
</html>