<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Strateger - Race Strategy Manager</title>
    
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect fill='%2322d3ee' width='100' height='100' rx='15'/><text x='50' y='70' text-anchor='middle' font-size='60' fill='black' font-weight='bold'>S</text></svg>">

    <!-- PWA -->
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#22d3ee">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Strateger">
    <link rel="apple-touch-icon" href="/icons/icon-192.svg">

    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://apis.google.com/js/api.js" async defer></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://bernardo-castilho.github.io/DragDropTouch/DragDropTouch.js"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

    <!-- PDF/Image export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" defer></script>

    <script src="js/racefacer-scraper.js"></script>
    <script src="js/apex-scraper.js"></script>
    <script src="js/live-timing-manager.js"></script>

    <link rel="stylesheet" href="css/style.css">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        navy: { 950: '#020617', 900: '#0f172a', 800: '#1e293b', 700: '#334155' },
                        ice: '#22d3ee', neon: '#a3e635', danger: '#ef4444', fuel: '#f97316',
                        squadA: '#3b82f6', squadB: '#06b6d4', squadC: '#a855f7', squadD: '#f97316', live: '#ef4444',
                        gold: '#fbbf24', silver: '#9ca3af', bronze: '#f97316'
                    },
                    animation: { 
                        'pulse-fast': 'pulse 1s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'flash': 'flash 0.5s ease-in-out'
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-navy-950 text-gray-200 flex flex-col">
    <header class="bg-navy-900 border-b border-gray-800 p-2 flex justify-between items-center shadow-md sticky top-0 z-20">
        <div class="flex items-center gap-2">
            <select id="langSelect" onchange="window.setLanguage(this.value)" 
                    class="text-xs bg-navy-800 px-1 py-0.5 rounded border border-gray-700 text-white cursor-pointer">
                <option value="en">üá¨üáß EN</option>
                <option value="he">üáÆüá± HE</option>
                <option value="fr">üá´üá∑ FR</option>
                <option value="pt">üáµüáπ PT</option>
                <option value="ru">üá∑üá∫ RU</option>
                <option value="ar">üá∏üá¶ AR</option>
                <option value="es">üá™üá∏ ES</option>
                <option value="it">üáÆüáπ IT</option>
                <option value="ka">üá¨üá™ KA</option>
                <option value="de">üá©üá™ DE</option>
                <option value="ja">üáØüáµ JA</option>
                <option value="el">üá¨üá∑ EL</option>
            </select>
            
            <div id="googleAuthCompact" class="flex items-center ml-2">
                <button id="googleSignInBtn" onclick="window.googleSignIn()" class="flex items-center gap-2 bg-white text-gray-700 hover:bg-gray-100 border border-gray-300 px-2 py-1 rounded text-[10px] font-bold transition" data-i18n="googleLoginBtn">
                    <img src="https://www.google.com/favicon.ico" class="w-3 h-3">
                    Login
                </button>

                <div id="googleUserDisplay" class="hidden flex items-center gap-2 bg-navy-800 border border-gray-600 px-2 py-1 rounded-full">
                    <img id="googleAvatarSmall" src="" class="w-4 h-4 rounded-full border border-ice">
                    <span id="googleNameSmall" class="text-xs text-white max-w-[80px] truncate hidden sm:block">User</span>
                    <button onclick="window.googleSignOut()" class="text-gray-400 hover:text-red-400 ml-1">
                        <i class="fas fa-sign-out-alt text-xs"></i>
                    </button>
                </div>
            </div>
        </div>

        <div class="flex items-center gap-2">
            <div id="syncControls" class="hidden flex items-center gap-1 bg-navy-800 px-2 py-1 rounded border border-gray-700">
                <span id="syncDot" class="sync-dot bg-green-500"></span>
                <span id="syncText" class="text-[10px] text-gray-400" data-i18n="synced">Synced</span>
            </div>
            
            <div id="liveIndicator" class="hidden sync-dot live-dot"></div>

            <button id="proStatusBtn" onclick="window.showProStatus()" class="hidden bg-gradient-to-r from-gold/20 to-amber-500/20 hover:from-gold/30 hover:to-amber-500/30 text-gold text-[10px] font-bold px-2 py-1 rounded-full border border-gold/50 transition flex items-center gap-1">
                ‚≠ê <span data-i18n="proBadge">PRO</span>
            </button>

            <button id="shareRaceBtn" onclick="window.copyInviteLink()" class="hidden bg-gradient-to-r from-ice to-blue-500 hover:from-blue-400 hover:to-ice text-navy-950 text-xs font-bold px-3 py-1.5 rounded-full shadow-lg transition transform active:scale-95 flex items-center gap-1">
                <i class="fas fa-link"></i>
                <span class="hidden sm:inline" data-i18n="invite">Invite</span>
            </button>

            <button id="driverLinkBtn" onclick="window.copyDriverLink()" class="hidden bg-gradient-to-r from-orange-500 to-amber-500 hover:from-amber-400 hover:to-orange-400 text-navy-950 text-xs font-bold px-3 py-1.5 rounded-full shadow-lg transition transform active:scale-95 flex items-center gap-1" title="Copy Driver Link">
                <i class="fas fa-car-side"></i>
                <span class="hidden sm:inline" data-i18n="driverLink">Driver</span>
            </button>

            <button id="themeToggleBtn" onclick="window.toggleThemePanel()" class="bg-navy-800 hover:bg-navy-700 text-gray-300 hover:text-white text-xs font-bold px-2 py-1.5 rounded-full border border-gray-700 hover:border-gray-500 transition transform active:scale-95 flex items-center gap-1" title="Theme">
                <i class="fas fa-palette"></i>
            </button>

            <button id="muteToggleBtn" onclick="window.toggleMute()" class="bg-navy-800 hover:bg-navy-700 text-gray-300 hover:text-white text-xs font-bold px-2 py-1.5 rounded-full border border-gray-700 hover:border-gray-500 transition transform active:scale-95 flex items-center gap-1" title="Mute">
                <i class="fas fa-volume-up"></i>
            </button>

            <button id="viewerManageBtn" onclick="window.openViewerApprovalModal()" class="hidden bg-gradient-to-r from-purple-600 to-blue-600 hover:from-purple-700 hover:to-blue-700 text-white text-xs font-bold px-3 py-1.5 rounded-full shadow-lg transition transform active:scale-95 flex items-center gap-1 relative">
                <i class="fas fa-users-cog"></i>
                <span class="hidden sm:inline">Manage Viewers</span>
                <span id="viewerPendingBadge" class="hidden absolute -top-1.5 -right-1.5 bg-red-500 text-white text-[10px] font-bold min-w-[18px] h-[18px] flex items-center justify-center rounded-full animate-pulse shadow-lg border-2 border-navy-900">0</span>
            </button>
        </div>
    </header>

    <div id="setupScreen" class="w-full bg-navy-950 relative p-2">
        
        <div class="max-w-lg mx-auto text-center mb-2">
            <div class="header-title font-bold tracking-widest text-white ml-2 sm:block">
                STRAT<span class="text-ice">EGER</span>
            </div>
            <div class="text-[9px] text-gray-400 uppercase tracking-wider ml-2 sm:block" data-i18n="appSubtitle">
                Endurance Race Strategy Manager
            </div>
            <div id="googleActionsBar" class="hidden grid grid-cols-4 gap-2 mb-4">
                <button onclick="window.showTeamEmailModal()" class="bg-navy-800 border border-gray-700 hover:border-ice p-2 rounded flex flex-col items-center gap-1 group">
                    <i class="fas fa-envelope text-ice group-hover:scale-110 transition"></i>
                    <span class="text-[9px] text-gray-400">Email</span>
                </button>
                <button onclick="window.showCalendarModal()" class="bg-navy-800 border border-gray-700 hover:border-neon p-2 rounded flex flex-col items-center gap-1 group">
                    <i class="fas fa-calendar-plus text-neon group-hover:scale-110 transition"></i>
                    <span class="text-[9px] text-gray-400">Calendar</span>
                </button>
                <button onclick="window.loadStrategyLibrary()" class="bg-navy-800 border border-gray-700 hover:border-gold p-2 rounded flex flex-col items-center gap-1 group">
                    <i class="fas fa-book text-gold group-hover:scale-110 transition"></i>
                    <span class="text-[9px] text-gray-400">Library</span>
                </button>
                <button onclick="window.checkTeamAvailability()" class="bg-navy-800 border border-gray-700 hover:border-purple-400 p-2 rounded flex flex-col items-center gap-1 group">
                    <i class="fas fa-clock text-purple-400 group-hover:scale-110 transition"></i>
                    <span class="text-[9px] text-gray-400">Check</span>
                </button>
            </div> 
        </div>

        <div id="configPanel" class="space-y-4 transition-opacity duration-300">
    
           <div class="bg-gradient-to-r from-red-900/30 to-navy-800 p-3 rounded-lg border border-red-500/50 relative">
                <span id="proLockLiveTiming" class="hidden absolute top-2 end-2 text-[10px] bg-gold/20 text-gold px-1.5 py-0.5 rounded-full font-bold border border-gold/30">üîí PRO</span>
                <div class="flex items-center gap-2 mb-2">
                    <span class="sync-dot live-dot"></span>
                    <span class="text-sm font-bold text-white" data-i18n="liveTiming">Live Timing</span>
                </div>
                
                <div class="mb-2">
                    <input type="url" id="liveTimingUrl" data-i18n="liveTimingUrl" placeholder="Live Timing URL..." class="input-field text-xs mb-1">
                </div>

                <div class="mb-2">
                    <label class="text-[10px] text-gray-400 block mb-1" data-i18n="ltSearchType">Filter By:</label>
                    <div class="flex gap-2 mb-1">
                        <label class="flex items-center gap-1 cursor-pointer">
                            <input type="radio" name="searchType" value="team" checked class="accent-red-500 w-3 h-3">
                            <span class="text-[10px] text-gray-300" data-i18n="ltTeam">Team</span>
                        </label>
                        <label class="flex items-center gap-1 cursor-pointer">
                            <input type="radio" name="searchType" value="driver" class="accent-red-500 w-3 h-3">
                            <span class="text-[10px] text-gray-300" data-i18n="ltDriver">Driver</span>
                        </label>
                        <label class="flex items-center gap-1 cursor-pointer">
                            <input type="radio" name="searchType" value="kart" class="accent-red-500 w-3 h-3">
                            <span class="text-[10px] text-gray-300" data-i18n="ltKart">Kart #</span>
                        </label>
                    </div>
                    <input type="text" id="searchValue" class="input-field text-xs" data-i18n="ltPlaceholder" placeholder="Search value...">
                </div>

                <div class="flex gap-2">
                    <button onclick="window.testLiveTiming()" class="flex-1 bg-red-900/50 border border-red-500/50 text-red-300 text-xs py-1.5 rounded hover:bg-red-900" data-i18n="testBtn">Test</button>
                    <button onclick="window.openManualInput()" class="flex-1 bg-fuel/20 border border-fuel/50 text-fuel text-xs py-1.5 rounded hover:bg-fuel/30" data-i18n="manualInput">Manual</button>
                </div>
                <div id="liveTimingStatus" class="text-[10px] text-gray-500 text-center mt-1"></div>
            </div>

            <div id="simResult" class="bg-black/40 border border-ice/30 p-3 rounded text-xs text-ice font-mono text-center whitespace-pre-line hidden">
                calculating...
            </div>

            <div id="invalidStrategyWarning" class="hidden bg-red-900/40 border border-red-500 p-3 rounded text-xs text-red-300 text-center font-bold">
                ‚ö†Ô∏è Invalid Strategy: Average stint <span id="averageStintValue">--</span> is outside bounds [<span id="minStintBound">30</span>-<span id="maxStintBound">65</span>] min
            </div>

            <!-- GENERAL INFO (collapsible) -->
            <div class="collapsible-section">
                <h2 class="text-ice text-lg font-bold mb-3 flex items-center gap-2 cursor-pointer select-none" onclick="this.parentElement.classList.toggle('collapsed')">
                    <i class="fas fa-cog"></i> <span data-i18n="generalInfo">General Info</span>
                    <i class="fas fa-chevron-down ml-auto text-xs text-gray-500 collapse-icon transition-transform"></i>
                </h2>
                <div class="collapse-body">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-xs text-gray-400 font-bold" data-i18n="lblDuration">Duration (Hours)</label>
                        <input type="number" id="raceDuration" value="12" onchange="window.runSim()" class="input-field text-lg font-bold">
                        <div class="flex gap-1 mt-1">
                            <button onclick="document.getElementById('raceDuration').value=1;window.runSim()" class="flex-1 text-[10px] py-0.5 rounded bg-navy-800 border border-gray-700 text-gray-400 hover:text-ice hover:border-ice/40 transition">1h</button>
                            <button onclick="document.getElementById('raceDuration').value=3;window.runSim()" class="flex-1 text-[10px] py-0.5 rounded bg-navy-800 border border-gray-700 text-gray-400 hover:text-ice hover:border-ice/40 transition">3h</button>
                            <button onclick="document.getElementById('raceDuration').value=6;window.runSim()" class="flex-1 text-[10px] py-0.5 rounded bg-navy-800 border border-gray-700 text-gray-400 hover:text-ice hover:border-ice/40 transition">6h</button>
                            <button onclick="document.getElementById('raceDuration').value=12;window.runSim()" class="flex-1 text-[10px] py-0.5 rounded bg-navy-800 border border-gray-700 text-gray-400 hover:text-ice hover:border-ice/40 transition">12h</button>
                            <button onclick="document.getElementById('raceDuration').value=24;window.runSim()" class="flex-1 text-[10px] py-0.5 rounded bg-navy-800 border border-gray-700 text-gray-400 hover:text-ice hover:border-ice/40 transition">24h</button>
                        </div>
                    </div>
                    <div>
                        <label class="text-xs text-gray-400 font-bold" data-i18n="lblStops">Req. Stops</label>
                        <input type="number" id="reqPitStops" value="15" onchange="window.runSim()" class="input-field text-neon text-lg font-bold">
                    </div>
                </div>
                <div class="grid grid-cols-3 gap-3 mt-3">
                    <div>
                        <label class="text-xs text-gray-400" data-i18n="lblMinStint">Min Stint (min)</label>
                        <input type="number" id="minStint" value="30" onchange="window.runSim()" class="input-field">
                    </div>
                    <div>
                        <label class="text-xs text-gray-400" data-i18n="lblMaxStint">Max Stint (min)</label>
                        <input type="number" id="maxStint" value="65" onchange="window.runSim()" class="input-field">
                    </div>
                    <div>
                        <label class="text-xs text-gray-400" data-i18n="lblPitTime">Pit Time (sec)</label>
                        <input type="number" id="minPitTime" value="120" onchange="window.runSim()" class="input-field">
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4 mt-3">
                    <div>
                        <label class="text-xs text-gray-400 font-bold" data-i18n="lblStartTime">üïê Race Start Time</label>
                        <input type="time" id="raceStartTime" onchange="window.runSim()" class="input-field">
                    </div>
                    <div>
                        <label class="text-xs text-gray-400 font-bold" data-i18n="lblStartDate">üìÖ Race Date</label>
                        <input type="date" id="raceStartDate" onchange="window.runSim()" class="input-field">
                    </div>
                </div>
                </div>
            </div>

            <!-- ADVANCED CONSTRAINTS (collapsible, merged with toggles) -->
            <div class="collapsible-section bg-navy-800 p-3 rounded border border-gray-700">
                <h2 class="text-gray-400 text-xs font-bold uppercase flex items-center gap-2 cursor-pointer select-none" onclick="this.parentElement.classList.toggle('collapsed')">
                    <i class="fas fa-sliders-h"></i> <span data-i18n="advancedConstraints">Advanced Constraints</span>
                    <i class="fas fa-chevron-down ml-auto text-[10px] text-gray-600 collapse-icon transition-transform"></i>
                </h2>
                <div class="collapse-body mt-3">
                <!-- Toggles -->
                <div class="flex flex-col gap-3 mb-3">
                    <div class="border-b border-gray-600 pb-2">
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" id="allowDouble" onchange="window.runSim()" class="accent-ice w-4 h-4">
                            <span class="text-sm text-gray-300" data-i18n="lblDoubles">Allow Double Stints</span>
                        </label>
                        <span class="text-xs text-gray-500 ml-6 block mt-1" data-i18n="lblDoublesHint">Same driver back-to-back</span>
                    </div>
                    <div class="border-b border-gray-600 pb-2">
                        <div class="flex items-center gap-2">
                            <span class="text-sm text-gray-300" data-i18n="lblSquads">Squads</span>
                            <span class="text-[9px] bg-gold/20 text-gold px-1 py-0.5 rounded font-bold border border-gold/30">‚≠ê PRO</span>
                            <select id="numSquads" onchange="window.toggleSquadsInput(); window.runSim()" class="bg-navy-900 text-white text-sm border border-gray-600 rounded px-2 py-1 cursor-pointer">
                                <option value="0" data-i18n-opt="squadOff">Off</option>
                                <option value="2" data-i18n-opt="squad2">2 Squads</option>
                                <option value="3" data-i18n-opt="squad3">3 Squads</option>
                                <option value="4" data-i18n-opt="squad4">4 Squads</option>
                            </select>
                        </div>
                        <span class="text-xs text-gray-500 block mt-1" data-i18n="lblSquadsHint">Rotate driver groups for long races</span>
                        <div id="squadScheduleContainer" class="hidden mt-2 space-y-2 bg-navy-950 p-2 rounded border border-gray-700">
                            <label class="text-[10px] text-gray-400 font-bold block" data-i18n="lblSquadSchedule">üîÑ Squad Window</label>
                            <div class="grid grid-cols-2 gap-2">
                                <div>
                                    <label class="text-[9px] text-gray-500 block" data-i18n="lblSquadWindowStart">Start</label>
                                    <input type="time" id="squadWindowStart" class="squad-start-time bg-navy-800 border border-gray-600 text-white rounded px-2 py-0.5 text-xs w-full" onchange="window.runSim()">
                                </div>
                                <div>
                                    <label class="text-[9px] text-gray-500 block" data-i18n="lblSquadWindowEnd">End</label>
                                    <input type="time" id="squadWindowEnd" class="bg-navy-800 border border-gray-600 text-white rounded px-2 py-0.5 text-xs w-full" onchange="window.runSim()">
                                </div>
                            </div>
                            <span class="text-[9px] text-gray-600 block" data-i18n="lblSquadScheduleHint">Outside this window all drivers share equally. Inside, squads rotate evenly.</span>
                        </div>
                    </div>
                    <div>
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" id="trackFuel" onchange="window.toggleFuelInput(); window.runSim()" class="accent-fuel w-4 h-4">
                            <span class="text-sm text-gray-300" data-i18n="lblFuel">Fuel Constraints</span>
                            <span class="text-[9px] bg-gold/20 text-gold px-1 py-0.5 rounded font-bold border border-gold/30">‚≠ê PRO</span>
                        </label>
                        <span class="text-xs text-gray-500 ml-6 block mt-1" data-i18n="lblFuelHint">Track fuel tank capacity</span>
                    </div>
                </div>
                <!-- Constraint fields -->
                <div class="grid grid-cols-2 gap-4 mb-3">
                    <div>
                        <label class="text-xs text-red-400 font-bold" data-i18n="lblPitClosedStart">üö´ Closed Start (min)</label>
                        <input type="number" id="pitClosedStart" value="0" onchange="window.runSim()" class="input-field border-red-900/50">
                    </div>
                    <div>
                        <label class="text-xs text-red-400 font-bold" data-i18n="lblPitClosedEnd">üö´ Closed End (min)</label>
                        <input type="number" id="pitClosedEnd" value="0" onchange="window.runSim()" class="input-field border-red-900/50">
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4 mb-3">
                    <div>
                        <label class="text-xs text-gray-400" data-i18n="lblMinDrive">Min Driver Total (min)</label>
                        <input type="number" id="minDriverTime" placeholder="0" onchange="window.runSim()" class="input-field">
                    </div>
                    <div>
                        <label class="text-xs text-gray-400" data-i18n="lblMaxDrive">Max Driver Total (min)</label>
                        <input type="number" id="maxDriverTime" placeholder="0" onchange="window.runSim()" class="input-field">
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-xs text-yellow-400 font-bold" data-i18n="lblBuffer">Pit Alert / Buffer (s)</label>
                        <input type="number" id="releaseBuffer" value="5" onchange="window.runSim()" class="input-field border-yellow-600/50">
                    </div>
                    <div id="fuelInputDiv" class="hidden">
                        <label class="text-xs text-fuel font-bold" data-i18n="lblFuelTank">Fuel Tank (min)</label>
                        <input type="number" id="fuelTime" onchange="window.runSim()" class="input-field border-fuel/50">
                    </div>
                </div>
                </div>
            </div>

            <!-- DRIVERS (collapsible) -->
            <div class="collapsible-section">
                <h2 class="text-ice text-lg font-bold mb-3 flex items-center gap-2 cursor-pointer select-none" onclick="this.parentElement.classList.toggle('collapsed')">
                    <i class="fas fa-users"></i> <span data-i18n="driverConfig">Drivers</span>
                    <i class="fas fa-chevron-down ml-auto text-xs text-gray-500 collapse-icon transition-transform"></i>
                </h2>
                <div class="collapse-body">
                <div id="driversList" class="space-y-2"></div>
                
                <div class="flex gap-2 mt-2">
                    <button onclick="window.addDriverField(); window.runSim()" class="btn-small bg-blue-600 w-full" data-i18n="addDriver">+ Add</button>
                    <button onclick="window.removeDriverField(); window.runSim()" class="btn-small bg-red-600 w-12">-</button>
                </div>
                </div>
            </div>
            




            <!-- RACE COUNTDOWN BANNER -->
            <div id="raceCountdownBanner" class="hidden rounded-lg border border-ice/30 p-2 text-center transition-all duration-500">
                <div id="raceCountdownText" class="text-sm font-bold text-ice"></div>
                <div class="flex items-center justify-center gap-3 mt-1">
                    <label class="flex items-center gap-1.5 cursor-pointer">
                        <input type="checkbox" id="autoStartRace" class="accent-green-500 w-3.5 h-3.5">
                        <span class="text-[10px] text-gray-400" data-i18n="lblAutoStart">Auto-start at race time</span>
                    </label>
                </div>
            </div>

            <div class="pt-2 space-y-2">
                <button onclick="window.generatePreview(false, true)" class="w-full bg-gradient-to-r from-purple-600 to-fuchsia-600 hover:from-purple-500 hover:to-fuchsia-500 text-white font-bold py-3 rounded shadow-lg transition">
                    <i class="fas fa-chart-bar mr-2"></i> <span data-i18n="previewStrategy">Preview Strategy</span>
                </button>

                <div class="flex gap-2">
                    <button id="startRaceBtn" onclick="window.initRace()" class="flex-1 bg-ice hover:bg-cyan-300 text-navy-950 font-bold py-4 rounded text-xl shadow-[0_0_15px_rgba(34,211,238,0.4)] transition uppercase tracking-wider" data-i18n="startRace">
                        Start Race
                    </button>
                    <button onclick="window.startDemoRace()" class="bg-neon/20 border-2 border-neon/50 text-neon font-bold py-4 px-4 rounded text-sm hover:bg-neon/30 transition" title="Start a 30-min demo race with simulated competitors">
                        <i class="fas fa-play-circle mr-1"></i> <span data-i18n="demoRace">Demo</span>
                    </button>
                </div>
                <button onclick="window.showDriverEntryScreen()" class="w-full bg-navy-800 border border-orange-500/30 hover:border-orange-400 text-orange-400 font-bold py-2 rounded text-sm transition flex items-center justify-center gap-2">
                    <i class="fas fa-car-side"></i> <span data-i18n="joinAsDriver">Join as Driver (enter Race ID)</span>
                </button>
            </div>

            <!-- PRO UPGRADE BANNER (free tier only) -->
            <div id="proUpgradeBanner" class="hidden bg-gradient-to-r from-gold/10 to-amber-500/10 border border-gold/30 rounded-lg p-3 text-center cursor-pointer hover:border-gold/50 transition" onclick="window.showProGate()">
                <div class="flex items-center justify-center gap-2">
                    <span class="text-lg">‚≠ê</span>
                    <span class="text-sm font-bold text-gold" data-i18n="proUpgradeTitle">Upgrade to Pro</span>
                </div>
                <div class="text-[10px] text-gray-500 mt-1">Live Timing ‚Ä¢ AI Strategy ‚Ä¢ Squads ‚Ä¢ Unlimited Drivers</div>
            </div>

            <!-- CONTACT US BUTTON -->
            <div class="pt-1">
                <button onclick="window.openContactUsModal()" class="w-full bg-navy-800 border border-gray-700 hover:border-ice text-gray-300 hover:text-white text-xs py-2 rounded transition flex items-center justify-center gap-2">
                    <i class="fas fa-envelope"></i> <span data-i18n="contactUs">Contact Us</span>
                </button>
            </div>

        </div>
    </div>

    <div id="previewScreen" class="hidden fixed inset-0 bg-navy-950 z-50 overflow-y-auto p-4 flex flex-col">
        <div class="max-w-3xl mx-auto w-full flex flex-col h-full">
            
            <div class="flex justify-between items-center mb-4 shrink-0">
                <h2 class="text-2xl font-bold text-white" data-i18n="previewTitle">Strategy Preview</h2>
                <button onclick="document.getElementById('previewScreen').classList.add('hidden'); document.getElementById('setupScreen').classList.remove('hidden');" class="text-gray-400 hover:text-white text-2xl">
                    &times;
                </button>
            </div>

            <div class="bg-navy-900 p-3 rounded-lg mb-4 shrink-0 border border-gray-700">
                <div class="flex flex-wrap gap-4 items-end justify-between">
                    <div>
                        <label class="text-xs text-gray-400 block mb-1" data-i18n="thStart">Start Time</label>
                        <div id="previewStartTimeDisplay" class="text-sm font-mono text-white bg-navy-800 border border-gray-600 rounded px-2 py-1">--:--</div>
                    </div>
                    
                    <div class="text-right">
                        <div class="text-xs text-gray-400" data-i18n="totalTime">Total Time</div>
                        <div class="text-xl font-mono text-neon flex items-center gap-2">
                            <span id="timelineStart">--:--</span>
                            <span id="timelineArrow" class="text-gray-600">‚ûú</span>
                            <span id="timelineEnd">--:--</span>
                        </div>
                    </div>
                </div>
                
                <button onclick="window.addToGoogleCalendar()" class="w-full mt-3 bg-blue-600/20 hover:bg-blue-600/30 border border-blue-500/50 text-blue-300 font-bold py-2 rounded-lg flex items-center justify-center gap-2 transition text-sm">
                    <i class="fab fa-google"></i> <span data-i18n="addToCalendar">Add to Google Calendar</span>
                </button>
            </div>

            <div class="flex-1 overflow-hidden flex flex-col gap-3 min-h-0">

                <!-- DRIVER SUMMARY (variable height, sits on top) -->
                <div class="shrink-0 bg-navy-900 rounded-lg border border-gray-700 overflow-hidden">
                    <div class="p-2 bg-navy-800 border-b border-gray-700 font-bold text-xs text-gray-300 uppercase tracking-wider" data-i18n="driverSchedule">
                        Driver Summary
                    </div>
                    <div id="strategySummary" class="p-2">
                        </div>
                </div>

                <!-- TIMELINE (scrollable, fills remaining space) -->
                <div class="flex-1 flex flex-col min-h-0 bg-navy-900 rounded-lg border border-gray-700 overflow-hidden">
                    <div class="p-2 bg-navy-800 border-b border-gray-700 font-bold text-xs text-gray-300 uppercase tracking-wider" data-i18n="timeline">
                        Timeline
                    </div>
                    <div id="driverScheduleList" class="flex-1 overflow-y-auto p-2 space-y-1">
                        </div>
                </div>
            </div>

            <div class="mt-4 flex gap-3 shrink-0">
                <button onclick="document.getElementById('previewScreen').classList.add('hidden'); document.getElementById('setupScreen').classList.remove('hidden');" class="flex-1 bg-navy-700 hover:bg-navy-600 text-gray-300 font-bold py-3 rounded transition" data-i18n="close">
                    Close
                </button>
                <button onclick="window.exportStrategyImage()" class="bg-purple-600/20 hover:bg-purple-600/30 border border-purple-500/50 text-purple-300 font-bold py-3 px-4 rounded transition text-sm flex items-center gap-1" title="Share as Image">
                    <i class="fas fa-image"></i>
                </button>
                <button onclick="window.exportStrategyPdf()" class="bg-blue-600/20 hover:bg-blue-600/30 border border-blue-500/50 text-blue-300 font-bold py-3 px-4 rounded transition text-sm flex items-center gap-1" title="Export PDF">
                    <i class="fas fa-file-pdf"></i> <span class="hidden sm:inline" data-i18n="exportPdf">PDF</span>
                </button>
                <button onclick="window.saveStrategy()" class="flex-1 bg-gold/20 hover:bg-gold/30 text-gold font-bold py-3 rounded border border-gold/50 transition" data-i18n="saveStratTitle">
                    Save
                </button>
                <button onclick="window.initRace()" class="flex-[2] bg-gradient-to-r from-neon to-green-500 hover:from-green-400 hover:to-green-600 text-black font-bold py-3 rounded shadow-lg transition" data-i18n="startRace">
                    Start Race
                </button>
            </div>
        </div>
    </div>

    <div id="raceDashboard" class="hidden flex flex-col h-full min-h-0 bg-navy-950 w-full relative">

        <div id="dashboardInfoBar" class="bg-navy-900 border-b border-gray-800 shrink-0 p-2 flex justify-between items-center z-[15] shadow-md sticky top-[42px]">
            <div class="flex items-center gap-1">
                <button id="btnRain" onclick="window.toggleRain()" class="bg-navy-800 border border-blue-500/50 rounded px-3 py-1 hover:bg-navy-700 transition">
                    <span id="rainIcon">‚òÄÔ∏è</span> <span id="rainText" class="text-xs font-bold text-yellow-400">Dry</span>
                </button>
            </div>
            <div class="text-center">
                <div class="text-[10px] text-gray-500 uppercase font-bold" data-i18n="raceTime">Race Time</div>
                <div id="raceTimerDisplay" class="text-xl font-mono font-bold text-white tracking-wider">00:00:00</div>
                <div id="demoBadge" class="hidden text-[8px] bg-neon/20 text-neon border border-neon/50 px-1.5 py-0.5 rounded-full font-bold uppercase tracking-wider">Demo</div>
            </div>
            <div class="text-center">
                <div class="text-[10px] text-gray-500 uppercase font-bold" data-i18n="stops">Stops</div>
                <div id="pitCountDisplay" class="text-base font-bold"><span class="text-neon">0</span>/<span>0</span></div>
            </div>
            <div id="pitStatusDisplay" class="text-center">
                <div class="text-[10px] text-gray-500 uppercase font-bold" data-i18n="statusHeader">STATUS</div>
                <div id="pitStatusIndicator" class="text-sm font-bold text-green-400">üèÅ ON TRACK</div>
            </div>
        </div>

        <div id="dashboardScrollArea" class="flex-1 overflow-y-auto overflow-x-hidden p-2 space-y-2">
            <div id="liveTimingPanel" class="hidden bg-navy-900/80 border-b border-red-500/50 p-2 rounded mb-2">
                <div class="flex justify-between items-center mb-1">
                    <div class="flex items-center gap-2">
                        <span class="sync-dot live-dot"></span> 
                        <span class="text-xs font-bold" data-i18n="live">LIVE</span>
                    </div>
                    <button onclick="window.stopLiveTiming()" class="text-[10px] bg-red-900 text-white px-2 rounded" data-i18n="stop">Stop</button>
                </div>
                <div class="grid grid-cols-3 gap-1 text-center">
                    <div class="bg-navy-950 rounded border border-gray-700 p-1">
                        <div class="text-[9px] text-gray-500" data-i18n="pos">POS</div>
                        <div class="flex items-center justify-center gap-1">
                            <span id="livePosition" class="text-lg font-bold text-ice">-</span>
                            <span id="livePositionChange" class="text-[10px] position-same"></span>
                        </div>
                    </div>
                    <div class="bg-navy-950 rounded border border-gray-700 p-1">
                        <div class="text-[9px] text-gray-500" data-i18n="last">LAST</div>
                        <div id="liveLastLap" class="text-sm font-mono">-</div>
                    </div>
                    <div class="bg-navy-950 rounded border border-gray-700 p-1">
                        <div class="text-[9px] text-gray-500" data-i18n="best">BEST</div>
                        <div id="liveBestLap" class="text-sm font-mono text-neon">-</div>
                    </div>
                </div>
                <div class="grid grid-cols-3 gap-1 text-center mt-1">
                    <div class="bg-navy-950 rounded border border-gray-700 p-1">
                        <div class="text-[9px] text-gray-500" data-i18n="laps">LAPS</div>
                        <div id="liveLaps" class="text-sm font-bold text-white">-</div>
                    </div>
                    <div class="bg-navy-950 rounded border border-gray-700 p-1">
                        <div class="text-[9px] text-gray-500" data-i18n="gap">GAP</div>
                        <div id="liveGap" class="text-sm font-mono text-fuel">-</div>
                    </div>
                    <div class="bg-navy-950 rounded border border-gray-700 p-1">
                        <div class="text-[9px] text-gray-500" data-i18n="totalCompetitors">CARS</div>
                        <div id="liveTotalCars" class="text-sm font-bold text-gray-300">-</div>
                    </div>
                </div>
                <div id="competitorsTable" class="mt-2 overflow-y-auto scroll-smooth scrollbar-thin" style="min-height:196px;max-height:280px;"></div>
                <div id="kartRankingPanel" class="hidden mt-1 p-2 bg-navy-950 rounded border border-gray-700/50"></div>
            </div>

            <div id="strategyBox" class="p-2 text-center bg-navy-900 border border-gray-700 rounded-lg shadow-sm">
                <div class="text-[10px] text-gray-400 font-bold tracking-widest" data-i18n="targetStint">TARGET STINT</div>
                <div class="flex justify-center items-baseline gap-2 my-1">
                    <span id="strategyTargetStint" class="text-3xl font-bold text-white font-mono">--:--</span>
                    <span id="strategyDelta" class="text-sm font-bold text-gray-400">--</span>
                </div>
                <div id="strategyAdvice" class="text-[10px] text-gray-500 font-bold uppercase tracking-widest" data-i18n="buildTime">BUILD TIME</div>
                <!-- Strategy schedule: next driver + squad info -->
                <div id="strategyScheduleBanner" class="hidden mt-1 pt-1 border-t border-gray-700/50 text-center"></div>
                <div id="squadStatusInfo" class="hidden mt-1 text-[10px]"></div>
            </div>

            <!-- Strategy notification toasts -->
            <div id="strategyToastContainer" class="space-y-1"></div>

            <div class="p-3 bg-navy-900 border border-gray-700 rounded-lg">
                <div class="flex justify-between items-center mb-2">
                    <div class="text-center w-1/2">
                        <div class="text-[9px] text-gray-500 uppercase" data-i18n="current">Current</div>
                        <div id="currentDriverName" class="text-lg font-bold text-ice truncate px-1">---</div>
                    </div>
                    <div class="text-center w-1/2">
                        <div class="text-[9px] text-gray-500 uppercase" data-i18n="stintTime">Stint Time</div>
                        <div id="stintTimerDisplay" class="text-2xl font-mono font-bold text-white">00:00</div>
                    </div>
                </div>
                
                <div class="relative h-6 bg-navy-950 rounded-full overflow-hidden mt-1 border border-gray-600 shadow-inner">
                    <div id="zoneForbidden" class="absolute top-0 left-0 h-full bg-red-900/40 w-0 border-r border-red-500 z-0"></div>
                    <div id="minStintLine" class="absolute top-0 bottom-0 w-0.5 bg-white z-10 hidden flex flex-col justify-center items-center">
                        <span class="text-[7px] bg-black/60 px-1 rounded text-white font-bold -mt-5 backdrop-blur-sm">MIN</span>
                    </div>
                    <div id="targetStintLine" class="absolute top-0 bottom-0 w-0.5 bg-ice z-10 hidden flex flex-col justify-center items-center">
                        <span class="text-[7px] bg-black/60 px-1 rounded text-ice font-bold -mt-5 backdrop-blur-sm">TGT</span>
                    </div>
                    <div id="stintProgressBar" class="absolute top-0 left-0 h-full bg-gradient-to-r from-green-600 to-neon transition-all duration-500 z-0 opacity-90" style="width: 0%"></div>
                </div>
            </div>
            
            <div class="p-1">
                <div class="grid gap-3 mb-2" id="modeButtonsContainer" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(0, 1fr));">
                    <button id="btnPush" onclick="window.setMode('push')" class="btn-press bg-navy-800 border border-green-500/30 rounded-lg py-3 px-2 text-sm text-gray-300 font-bold shadow-md hover:bg-navy-700 transition flex flex-row items-center justify-center gap-2">
                        <span class="text-lg">üî•</span> 
                        <span data-i18n="push">PUSH</span>
                    </button>
                    
                    <button id="btnBad" onclick="window.setMode('bad')" class="btn-press bg-navy-800 border border-red-500/30 rounded-lg py-3 px-2 text-sm text-gray-300 font-bold shadow-md hover:bg-navy-700 transition flex flex-row items-center justify-center gap-2">
                        <span class="text-lg">üê¢</span> 
                        <span data-i18n="problem">PROBLEM</span>
                    </button>

                    <button id="btnNightMode" onclick="window.toggleNightMode()" class="hidden bg-navy-800 hover:bg-indigo-800 border border-indigo-500/50 text-indigo-200 text-xs font-bold py-3 px-2 rounded transition flex flex-row items-center justify-center gap-2 shadow-lg">
                        <span class="text-lg">üåô</span> 
                        <span id="nightModeText" data-i18n="nightMode">NIGHT</span>
                    </button>
                    
                    <button id="btnSwitchSquad" onclick="window.switchNightSquad()" class="hidden bg-navy-800 hover:bg-squadA border border-squadB/50 text-squadB text-xs font-bold py-3 px-2 rounded transition flex flex-row items-center justify-center gap-2 shadow-lg" title="Switch active squad">
                        <span class="text-lg">üîÑ</span> 
                        <span id="switchSquadText" data-i18n="squadSwitch">Switch Squad</span>
                    </button>
                </div>
                
                <button id="btnResetMode" onclick="window.setMode('normal')" class="hidden w-full bg-gray-700/50 hover:bg-gray-600 border border-gray-500 text-white text-xs font-bold py-2 rounded mb-2 transition uppercase tracking-wider">
                    üîÑ <span data-i18n="resetMode">Reset Mode</span>
                </button>
            </div>

            <div id="remainingStintsPanel" class="p-2 bg-navy-900 border border-gray-700 rounded text-[10px] flex justify-between items-center hidden">
                <div class="flex flex-col">
                    <span class="text-gray-400 font-bold" data-i18n="strategyOutlook">STRATEGY OUTLOOK</span>
                    <span id="remStintsText" class="text-ice font-mono text-xs">...</span>
                </div>
                <div class="text-right">
                    <div class="text-gray-500 font-bold" data-i18n="timeLeft">TIME LEFT</div>
                    <div id="remTimeText" class="text-white font-mono font-bold">--:--</div>
                </div>
            </div>

            <div class="bg-navy-900 border border-gray-700 rounded-lg overflow-hidden">
                <table class="w-full text-sm">
                    <thead class="text-gray-400 text-[10px] bg-navy-950 border-b border-gray-700">
                        <tr>
                            <th class="text-left p-2" data-i18n="driverHeader">DRIVER</th>
                            <th class="text-center p-2" data-i18n="stops">STINTS</th>
                            <th class="text-right p-2" data-i18n="totalHeader">TOTAL</th>
                        </tr>
                    </thead>
                    <tbody id="statsTable" class="divide-y divide-gray-800"></tbody>
                </table>
            </div>
            
            <div class="h-2"></div>
            <div class="bg-navy-900 border-t border-gray-800 p-3 shrink-0 space-y-3 z-20 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.3)]">
            
                <div class="flex justify-between items-center">
                    <div class="text-xs text-gray-400 flex flex-col">
                        <span class="font-bold text-[9px] uppercase tracking-wider" data-i18n="nextDriverLabel">Next Driver</span>
                        <span id="nextDriverName" class="text-lg font-bold text-neon cursor-pointer hover:text-white transition truncate max-w-[120px]" onclick="window.cycleNextDriver(false, true)">---</span>
                    </div>

                    <div class="flex items-center gap-2 bg-navy-950 p-1.5 rounded border border-gray-700">
                        <span class="text-[9px] text-gray-500 uppercase font-bold px-1" data-i18n="penalty">Penalty</span>
                        <div class="flex gap-1">
                            <button id="penaltyBtnMinus5" onclick="window.adjustPitTime(-5)" class="penalty-btn bg-green-900/30 hover:bg-green-800 text-green-400 border border-green-600/30 px-2 py-1 rounded text-xs font-bold transition">-5</button>
                            <button id="penaltyBtnPlus5" onclick="window.adjustPitTime(5)" class="penalty-btn bg-red-900/30 hover:bg-red-800 text-red-400 border border-red-600/30 px-2 py-1 rounded text-xs font-bold transition">+5</button>
                            <button id="penaltyBtnPlus10" onclick="window.adjustPitTime(10)" class="penalty-btn bg-red-900/30 hover:bg-red-800 text-red-400 border border-red-600/30 px-2 py-1 rounded text-xs font-bold transition">+10</button>
                        </div>
                        <div id="dashboardPitAdjDisplay" class="bg-black/30 px-2 py-1 rounded text-ice font-mono font-bold text-xs min-w-[30px] text-center">0</div>
                    </div>
                </div>

                <button id="pitEntryBtn" onclick="window.confirmPitEntry()" class="w-full bg-gradient-to-r from-red-600 to-red-500 hover:from-red-500 hover:to-red-400 text-white font-bold py-4 rounded-xl text-xl shadow-lg transition transform active:scale-95 flex justify-between px-6 items-center border border-red-400/30">
                    <span class="flex items-center gap-3">
                        <i class="fas fa-flag-checkered text-2xl"></i> 
                        <span id="pitEntryBtnLabel" class="tracking-wider" data-i18n="enterPit">ENTER PIT</span>
                    </span>
                    <span id="btnPitAdjBadge" class="hidden text-sm bg-black/40 px-2 py-1 rounded text-yellow-300 font-mono border border-yellow-500/50"></span>
                </button>
            </div>
        </div>
    </div>

    <!-- ==================== DRIVER MODE HUD ==================== -->
    <div id="driverModePanel" class="hidden fixed inset-0 z-40 flex flex-col bg-black">

        <!-- ===== TOP HALF: STATUS ZONE ===== -->
        <div id="driverStatusZone" class="driver-status-zone cursor-pointer" onclick="window.driverPitTap()" style="flex:1;min-height:0;">
            <!-- Exit button (top-left, small) -->
            <button onclick="event.stopPropagation(); window.toggleDriverMode()" class="absolute top-2 left-2 z-10 text-white/30 text-lg px-2 py-1">‚úï</button>
            <!-- Race timer (top-right, small) -->
            <div class="absolute top-2 right-2 z-10 flex items-center gap-2">
                <div id="driverDemoBadge" class="hidden text-[10px] bg-neon/20 text-neon border border-neon/50 px-1.5 py-0.5 rounded-full font-bold">DEMO</div>
                <div id="driverRaceTimer" class="driver-race-timer">00:00:00</div>
            </div>
            <!-- Big status content (centered, overflow-safe) -->
            <div class="flex flex-col items-center justify-center h-full w-full px-4 overflow-hidden" style="min-height:0;">
                <div id="driverStatusEmoji" class="driver-emoji">üèéÔ∏è</div>
                <div id="driverStatusMsg" class="driver-msg">ON TRACK</div>
                <div id="driverStatusSub" class="driver-sub"></div>
            </div>
            <!-- Tap hint -->
            <div id="driverTapHint" class="absolute bottom-3 inset-x-0 text-center text-white/25 text-[10px] font-bold uppercase tracking-widest" data-i18n="tapToPit">TAP TO ENTER PIT</div>
            <!-- Next stint notification banner -->
            <div id="driverNextStintBanner" class="hidden absolute top-10 inset-x-0 mx-4 z-10 bg-black/80 border border-amber-500/50 rounded-lg px-3 py-2 text-center">
                <div id="driverNextStintText" class="text-amber-400 text-sm font-bold"></div>
                <div id="driverSleepStatus" class="text-xs mt-0.5"></div>
            </div>
        </div>

        <!-- ===== BOTTOM HALF: DATA ===== -->
        <div class="flex flex-col justify-between bg-black overflow-hidden" style="flex:1;min-height:0;">

            <!-- STINT TIMER ‚Äî the hero number -->
            <div class="flex flex-col items-center justify-center pt-1" style="flex:2;min-height:0;">
                <div class="driver-label" data-i18n="stintTime">STINT</div>
                <div id="driverStintTimer" class="driver-stint-timer">--:--</div>
                <!-- Delta under stint -->
                <div id="driverDelta" class="driver-delta">+0:00</div>
            </div>

            <!-- TARGET / LAST / BEST / POS ‚Äî 4 columns -->
            <div class="grid grid-cols-4 gap-0 border-t border-gray-800" style="flex:1;min-height:0;">
                <div class="flex flex-col items-center justify-center border-r border-gray-800">
                    <div class="driver-label" data-i18n="targetLabel">TARGET</div>
                    <div id="driverTargetTime" class="driver-data text-neon">--:--</div>
                </div>
                <div class="flex flex-col items-center justify-center border-r border-gray-800">
                    <div class="driver-label" data-i18n="last">LAST</div>
                    <div id="driverLastLap" class="driver-data text-gray-300">--</div>
                </div>
                <div class="flex flex-col items-center justify-center border-r border-gray-800">
                    <div class="driver-label" data-i18n="stintBest">S.BEST</div>
                    <div id="driverBestLap" class="driver-data text-neon">--</div>
                </div>
                <div class="flex flex-col items-center justify-center">
                    <div class="driver-label" data-i18n="pos">POS</div>
                    <div class="flex items-baseline gap-1">
                        <span id="driverPosition" class="driver-data text-ice">-</span>
                        <span id="driverPosChange" class="driver-pos-change"></span>
                    </div>
                </div>
            </div>

            <!-- Progress bar ‚Äî bottom strip -->
            <div class="px-3 pb-2 pt-1 shrink-0">
                <div class="relative rounded-full overflow-hidden border border-gray-700" style="height:2vh;min-height:10px;">
                    <div id="driverProgressBar" class="absolute top-0 left-0 h-full bg-gradient-to-r from-green-600 to-neon transition-all duration-500" style="width:0%"></div>
                    <div id="driverTargetLine" class="absolute top-0 bottom-0 w-0.5 bg-white z-10 hidden"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="pitModal" class="hidden fixed inset-0 bg-navy-950/95 z-50 flex flex-col items-center justify-center p-4">
        <h2 class="text-ice text-3xl font-bold mb-2 tracking-widest animate-pulse" data-i18n="inPit">IN PIT</h2>
        <p class="text-gray-400 mb-4"><span data-i18n="nextLabel">Next:</span> <span id="modalNextDriverName" class="text-white font-bold text-xl">---</span></p>
        
        <div id="pitStintWarning" class="hidden bg-red-900/80 border border-red-500 text-white px-4 py-2 rounded mb-4 text-center animate-bounce" data-i18n="shortStintMsg">‚ö†Ô∏è <span class="font-bold">SHORT STINT!</span> Penalty Risk</div>

        <div class="text-6xl font-bold font-mono text-white mb-2" id="pitTimerDisplay">00.0</div>
        
        <div id="modalPitAdjInfo" class="text-sm text-gray-500 mb-8 font-mono hidden">
            <span data-i18n="includesAdj">Includes adjustment:</span> <span id="modalPitAdjValue" class="text-white font-bold">0s</span>
        </div>
        
        <button id="notifyBtn" class="hidden w-full max-w-xs bg-fuel text-black font-bold py-3 rounded-lg text-lg mb-2" data-i18n="notifyDriver">üì¢ Notify Driver</button>
        <div id="notifiedMsg" class="hidden text-fuel font-bold mb-4" data-i18n="driverNotified">‚úì Driver Notified</div>

        <div id="pitWarningBox" class="hidden w-full max-w-xs bg-orange-600/50 border border-orange-500 text-white font-bold py-3 rounded-lg mb-2 text-center text-sm" data-i18n="orangeZone">‚ö†Ô∏è Orange zone - NOTIFY only</div>

        <button id="confirmExitBtn" disabled onclick="window.confirmPitExit()" class="w-full max-w-xs bg-gray-800 text-gray-500 font-bold py-4 rounded-lg text-2xl border border-gray-700 transition-all">Wait...</button>
        
        <button onclick="window.cancelPitStop()" class="text-red-400 mt-6 text-sm underline hover:text-red-300" data-i18n="cancelEntry">Cancel Entry</button>
    </div>
    
    <div id="emailTeamModal" class="hidden fixed inset-0 bg-navy-950/95 z-50 flex items-center justify-center p-4">
        <div class="bg-navy-900 border border-gray-700 p-4 rounded w-full max-w-md">
            <h3 class="text-ice font-bold mb-2">Send Email</h3>
            <input type="text" id="emailRecipients" placeholder="Emails..." class="input-field mb-2">
            <input type="text" id="emailSubject" value="Race Strategy" class="input-field mb-2">
            <textarea id="emailMessage" class="input-field mb-2 h-20"></textarea>
            <label class="flex gap-2 text-xs text-gray-300 mb-2"><input type="checkbox" id="attachStrategy" checked> Attach Strategy</label>
            <div class="flex gap-2">
                <button onclick="window.sendTeamEmail()" class="flex-1 bg-ice text-navy-950 font-bold py-2 rounded">Send</button>
                <button onclick="window.closeEmailModal()" class="flex-1 bg-navy-700 text-gray-300 py-2 rounded">Cancel</button>
            </div>
        </div>
    </div>
    
    <div id="calendarModal" class="hidden fixed inset-0 bg-navy-950/95 z-50 flex items-center justify-center p-4">
        <div class="bg-navy-900 border border-gray-700 p-4 rounded w-full max-w-md">
            <h3 class="text-neon font-bold mb-2">Add to Calendar</h3>
            <input type="text" id="calendarTitle" placeholder="Title" class="input-field mb-2">
            <div class="mb-2">
                <label class="text-xs text-gray-400 mb-1 block">Start</label>
                <div class="flex gap-2">
                    <input type="date" id="calendarDate" class="input-field flex-1">
                    <input type="time" id="calendarTime" class="input-field flex-1">
                </div>
            </div>
            <div class="mb-2">
                <label class="text-xs text-gray-400 mb-1 flex items-center gap-2">
                    <input type="checkbox" id="calendarUseRange" onchange="window.toggleCalendarRange()" class="rounded">
                    <span>Date Range (e.g., vacation/trip)</span>
                </label>
                <div id="calendarEndDateContainer" class="hidden mt-1">
                    <label class="text-xs text-gray-400 mb-1 block">End</label>
                    <div class="flex gap-2">
                        <input type="date" id="calendarEndDate" class="input-field flex-1">
                        <input type="time" id="calendarEndTime" class="input-field flex-1">
                    </div>
                </div>
            </div>
            <input type="text" id="calendarLocation" placeholder="Location" class="input-field mb-2">
            <div class="flex gap-2">
                <button onclick="window.createCalendarEvent()" class="flex-1 bg-neon text-navy-950 font-bold py-2 rounded">Create</button>
                <button onclick="window.closeCalendarModal()" class="flex-1 bg-navy-700 text-gray-300 py-2 rounded">Cancel</button>
            </div>
        </div>
    </div>

    <div id="saveStrategyModal" class="hidden fixed inset-0 bg-navy-950/95 z-50 flex items-center justify-center p-4">
        <div class="bg-navy-900 border border-gray-700 p-4 rounded w-full max-w-md">
            <h3 class="text-white font-bold mb-2">Save Strategy</h3>
            <input type="text" id="saveStrategyName" placeholder="Strategy Name" class="input-field mb-2">
            <div class="flex gap-4 mb-4 text-gray-300 text-xs">
                <label><input type="radio" name="strategyVisibility" value="private" checked> Private</label>
                <label><input type="radio" name="strategyVisibility" value="public"> Public</label>
            </div>
            <div class="flex gap-2">
                <button onclick="window.performStrategySave()" class="flex-1 bg-ice text-navy-950 font-bold py-2 rounded">Save</button>
                <button onclick="window.closeSaveStrategyModal()" class="flex-1 bg-navy-700 text-gray-300 py-2 rounded">Cancel</button>
            </div>
        </div>
    </div>
    
    <div id="strategyModal" class="hidden fixed inset-0 bg-navy-950/95 z-50 flex items-center justify-center p-4">
        <div class="bg-navy-900 border border-gray-700 rounded w-full max-w-lg max-h-[80vh] flex flex-col">
            <div class="p-3 border-b border-gray-700 flex justify-between items-center">
                <h3 class="text-ice font-bold">Saved Strategies</h3>
                <button onclick="window.closeStrategyModal()" class="text-gray-400">&times;</button>
            </div>
            <div id="strategyList" class="p-3 overflow-y-auto flex-1 text-xs space-y-2">Loading...</div>
        </div>
    </div>
    
    <div id="savedRaceModal" class="hidden fixed inset-0 bg-navy-950/98 z-50 flex items-center justify-center p-4">
        <div class="bg-navy-900 border-2 border-ice p-6 rounded-lg w-full max-w-sm text-center">
            <h2 class="text-xl font-bold text-ice mb-2" data-i18n="activeRaceFound">Active Race Found</h2>
            <div class="text-gray-400 text-sm mb-4">
                <span data-i18n="thDriver">Driver</span>: <span id="savedRaceDriver" class="text-white"></span><br>
                Remaining: <span id="savedRaceTime" class="text-neon"></span>
            </div>
            <button onclick="window.continueRace()" class="w-full bg-ice text-navy-950 font-bold py-3 rounded mb-2" data-i18n="continueRace">Continue Race</button>
            <button onclick="window.confirmDiscardRace()" class="w-full bg-navy-800 text-gray-400 py-2 rounded" data-i18n="discardRace">Discard</button>
        </div>
    </div>
    
    <div id="confirmDiscardModal" class="hidden fixed inset-0 bg-black/90 z-[60] flex items-center justify-center p-4">
        <div class="bg-red-900/20 border border-red-500 p-6 rounded w-full max-w-xs text-center">
            <h3 class="text-red-500 font-bold text-lg mb-2" data-i18n="areYouSure">Are you sure?</h3>
            <p class="text-gray-300 text-xs mb-4" data-i18n="deleteWarning">This will delete the active race data permanently.</p>
            <div class="flex gap-2">
                <button onclick="window.finalDiscardRace()" class="flex-1 bg-red-600 text-white font-bold py-2 rounded" data-i18n="yesDelete">Yes, Delete</button>
                <button onclick="window.cancelDiscard()" class="flex-1 bg-navy-700 text-gray-300 py-2 rounded" data-i18n="noKeep">No, Keep</button>
            </div>
        </div>
    </div>

    <div id="manualInputModal" class="hidden fixed inset-0 bg-navy-950/95 z-50 flex items-center justify-center p-4">
        <div class="bg-navy-900 border border-gray-700 p-4 rounded w-full max-w-xs">
            <h3 class="text-ice font-bold mb-3" data-i18n="manualInput">Manual Input</h3>
            <div class="space-y-2">
                <div class="flex gap-2">
                    <div class="flex-1">
                        <label class="text-[10px] text-gray-400 block mb-0.5" data-i18n="pos">POS</label>
                        <input type="number" id="manualPosition" placeholder="1" min="1" class="input-field text-center">
                    </div>
                    <div class="flex-1">
                        <label class="text-[10px] text-gray-400 block mb-0.5" data-i18n="laps">LAPS</label>
                        <input type="number" id="manualLaps" placeholder="0" min="0" class="input-field text-center">
                    </div>
                </div>
                <div class="flex gap-2">
                    <div class="flex-1">
                        <label class="text-[10px] text-gray-400 block mb-0.5" data-i18n="last">Last Lap (s)</label>
                        <input type="number" id="manualLastLap" placeholder="65.500" step="0.001" min="0" class="input-field text-center">
                    </div>
                    <div class="flex-1">
                        <label class="text-[10px] text-gray-400 block mb-0.5" data-i18n="best">Best Lap (s)</label>
                        <input type="number" id="manualBestLap" placeholder="63.200" step="0.001" min="0" class="input-field text-center">
                    </div>
                </div>
                <div>
                    <label class="text-[10px] text-gray-400 block mb-0.5" data-i18n="gap">Gap (s)</label>
                    <input type="number" id="manualGap" placeholder="0.000" step="0.001" class="input-field text-center">
                </div>
                <div class="flex gap-2 mt-1">
                    <button onclick="window.applyManualInput()" class="flex-1 bg-ice text-navy-950 font-bold py-2 rounded" data-i18n="save">Apply</button>
                    <button onclick="window.closeManualInput()" class="flex-1 bg-navy-700 text-gray-300 py-2 rounded" data-i18n="cancel">Cancel</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ==================== DRIVER ID ENTRY SCREEN ==================== -->
    <div id="driverEntryScreen" class="hidden fixed inset-0 bg-navy-950 z-[100] flex flex-col items-center justify-center p-6">
        <div class="text-center mb-6">
            <div class="text-4xl mb-2">üèéÔ∏è</div>
            <h1 class="text-2xl font-bold text-ice tracking-widest">DRIVER MODE</h1>
            <p class="text-sm text-gray-400 mt-1" data-i18n="driverEntryHint">Enter the race ID to connect</p>
        </div>
        <div class="w-full max-w-xs space-y-4">
            <div>
                <label class="text-xs text-gray-400 block mb-1 font-bold" data-i18n="driverEntryLabel">Race ID (7 digits)</label>
                <input type="text" id="driverIdInput" maxlength="15" 
                    class="w-full text-center text-2xl font-mono tracking-[0.3em] bg-navy-900 border-2 border-ice/50 text-white rounded-lg px-4 py-4 focus:border-ice focus:outline-none transition"
                    placeholder="ABC1234" autocomplete="off" inputmode="text"
                    onkeydown="if(event.key==='Enter') window.submitDriverId()">
            </div>
            <button onclick="window.submitDriverId()" class="w-full bg-gradient-to-r from-orange-500 to-amber-500 hover:from-amber-400 hover:to-orange-400 text-navy-950 font-bold py-4 rounded-xl text-xl shadow-lg transition transform active:scale-95 flex items-center justify-center gap-2">
                <i class="fas fa-car-side"></i> <span data-i18n="driverConnect">Connect as Driver</span>
            </button>
            <div id="driverEntryError" class="hidden text-red-400 text-sm text-center"></div>
            <div class="text-center">
                <a href="#" onclick="event.preventDefault(); document.getElementById('driverEntryScreen').classList.add('hidden'); document.getElementById('setupScreen').classList.remove('hidden');" class="text-xs text-gray-500 hover:text-gray-300 transition" data-i18n="backToSetup">‚Üê Back to Setup</a>
            </div>
        </div>
    </div>

    <!-- ==================== VIEWER NAME ENTRY SCREEN ==================== -->
    <div id="viewerNameScreen" class="hidden fixed inset-0 bg-navy-950 z-[100] flex flex-col items-center justify-center p-6">
        <div class="text-center mb-6">
            <div class="text-4xl mb-2">üëÄ</div>
            <h1 class="text-2xl font-bold text-ice tracking-widest">STRATEGER</h1>
            <p class="text-sm text-gray-400 mt-1" data-i18n="viewerNameHint">Enter your name to join the race</p>
        </div>
        <div class="w-full max-w-xs space-y-4">
            <div>
                <label class="text-xs text-gray-400 block mb-1 font-bold" data-i18n="viewerNameLabel">Your Name</label>
                <input type="text" id="viewerNameInput" maxlength="30"
                    class="w-full text-center text-xl font-bold bg-navy-900 border-2 border-ice/50 text-white rounded-lg px-4 py-4 focus:border-ice focus:outline-none transition"
                    placeholder="Name / Team name" autocomplete="off"
                    onkeydown="if(event.key==='Enter') window.submitViewerName()">
            </div>
            <button onclick="window.submitViewerName()" class="w-full bg-gradient-to-r from-blue-600 to-cyan-500 hover:from-cyan-400 hover:to-blue-500 text-white font-bold py-4 rounded-xl text-xl shadow-lg transition transform active:scale-95 flex items-center justify-center gap-2">
                <i class="fas fa-eye"></i> <span data-i18n="requestToJoin">Request to Join</span>
            </button>
            <div id="viewerNameError" class="hidden text-red-400 text-sm text-center"></div>
            <div id="viewerWaitingMsg" class="hidden text-center">
                <div class="text-2xl animate-pulse mb-2">‚è≥</div>
                <div class="text-ice font-bold" data-i18n="waitingForApproval">Waiting for host approval...</div>
                <div class="text-xs text-gray-500 mt-1" data-i18n="waitingForApprovalHint">The race admin will approve your request</div>
            </div>
        </div>
    </div>

    <div id="clientWaitScreen" class="hidden fixed inset-0 bg-navy-950 z-[100] flex flex-col items-center justify-center text-ice">
        <div class="text-3xl animate-pulse font-bold">Connecting to Race...</div>
        <div class="text-sm text-gray-500 mt-2">Waiting for host to start race</div>
    </div>

    <button id="chatToggleBtn" onclick="window.toggleChat()" class="fixed bottom-4 right-4 z-50 bg-blue-600 hover:bg-blue-500 text-white p-3 rounded-full shadow-lg border border-blue-400" style="display: none;">
        <i class="fas fa-comment-dots text-xl"></i>
        <span id="chatUnreadBadge" class="hidden absolute -top-1 -left-1 bg-red-500 text-white text-[10px] font-bold px-1.5 py-0.5 rounded-full">0</span>
    </button>

    <div id="chatPanel" class="hidden fixed bottom-16 right-4 z-50 w-72 h-80 bg-navy-900 border border-gray-700 rounded-lg shadow-2xl flex flex-col overflow-hidden">
        <div class="bg-navy-800 p-2 border-b border-gray-700 flex justify-between items-center">
            <h3 class="text-xs font-bold text-ice" data-i18n="chatTitle">Race Chat</h3>
            <button onclick="window.toggleChat()" class="text-gray-400 hover:text-white">&times;</button>
        </div>

        <div id="chatLoginView" class="flex-1 p-4 flex flex-col justify-center gap-2">
            <div id="chatLoginHint" class="text-xs text-gray-400 text-center mb-2">üí¨ Join the chat or just watch the race</div>
            <input type="text" id="chatUserName" class="input-field text-sm" placeholder="Enter your name / team name">
            <div id="chatJoinError" class="text-sm text-yellow-400 hidden"></div>
            <button onclick="window.joinChat()" class="bg-ice text-navy-950 font-bold py-2 rounded text-sm hover:bg-cyan-300" id="chatJoinBtn">Join Chat</button>
            <button onclick="window.skipChat()" class="bg-gray-700 text-gray-100 py-2 rounded text-sm hover:bg-gray-600 text-xs" id="chatSkipBtn">Just Watch (No Chat)</button>
        </div>

        <div id="chatMessagesView" class="hidden flex-1 flex flex-col min-h-0">
            <!-- Viewer selector (host only) -->
            <div id="chatViewerSelector" class="hidden bg-navy-950 border-b border-gray-700 p-2">
                <label class="text-[9px] text-gray-400 font-bold block mb-1">Send to:</label>
                <select id="chatRecipientSelect" class="w-full bg-navy-800 border border-gray-600 text-white rounded px-2 py-1 text-xs">
                    <option value="broadcast">All Viewers</option>
                </select>
            </div>
            
            <div id="chatFeed" class="flex-1 overflow-y-auto p-2 space-y-2 text-xs">
                </div>
            <!-- Reply context display -->
            <div id="chatReplyContext" class="hidden bg-navy-900 border-b border-blue-500/30 p-2 text-[10px]">
                <div class="flex justify-between items-start gap-2">
                    <div>
                        <span class="text-blue-400 font-bold" id="replyContextSender"></span>
                        <div class="text-gray-300 mt-1" id="replyContextText"></div>
                    </div>
                    <button onclick="window.clearReplyContext()" class="text-gray-400 hover:text-white text-lg leading-none">√ó</button>
                </div>
            </div>
            <div class="p-2 bg-navy-800 border-t border-gray-700 flex gap-1">
                <input type="text" id="chatInput" class="input-field text-xs" data-i18n="typeMessage" placeholder="Type...">
                <button onclick="window.sendChatMessage()" class="bg-blue-600 text-white px-3 rounded hover:bg-blue-500">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Viewer Approval Modal (Host Only) -->
    <div id="viewerApprovalModal" class="hidden fixed inset-0 bg-navy-950/95 z-[110] flex items-center justify-center p-4">
        <div class="bg-navy-900 border border-gray-700 rounded-lg p-6 max-w-md w-full max-h-[70vh] overflow-y-auto">
            <h3 class="text-lg font-bold text-ice mb-4 flex items-center gap-2">
                <i class="fas fa-user-check"></i>
                <span data-i18n="viewerApprovalRequest">Viewer Approval Requests</span>
            </h3>
            
            <div id="pendingViewersList" class="space-y-3">
                <!-- Pending viewers will be rendered here -->
            </div>
            
            <div id="approvedViewersList" class="mt-6 pt-4 border-t border-gray-700">
                <h4 class="text-sm font-bold text-gray-400 mb-3">Approved Viewers</h4>
                <div id="approvedViewersContent" class="space-y-2">
                    <!-- Approved viewers will be rendered here -->
                </div>
            </div>
            
            <button onclick="window.closeViewerApprovalModal()" class="w-full bg-navy-700 text-gray-300 py-2 rounded mt-6 hover:bg-navy-600">
                <span data-i18n="close">Close</span>
            </button>
        </div>
    </div>

    <!-- ==================== THEME PICKER PANEL ==================== -->
    <div id="themePanel" class="hidden fixed inset-0 z-[55] flex items-end justify-center" onclick="if(event.target===this)window.toggleThemePanel()">
        <div class="w-full max-w-lg bg-navy-950 border-t border-gray-700 rounded-t-2xl shadow-2xl p-4 pb-6 animate-slide-up">
            <div class="flex items-center justify-between mb-3">
                <h3 class="text-ice text-sm font-bold flex items-center gap-2"><i class="fas fa-palette"></i> <span data-i18n="lblAppearance">Appearance</span></h3>
                <button onclick="window.toggleThemePanel()" class="text-gray-500 hover:text-white text-lg px-2">‚úï</button>
            </div>
            <div id="bgSwatches" class="grid grid-cols-4 gap-2 items-center">
                <button class="bg-swatch active w-full aspect-[3/2] rounded-lg border-2 border-gray-600 hover:border-white transition overflow-hidden relative group" data-bg="" title="Default" onclick="window.setPageBackground('')">
                    <div class="absolute inset-0" style="background: linear-gradient(135deg, #020617 50%, #1e293b 100%);"></div>
                    <span class="absolute bottom-0 inset-x-0 text-[8px] text-gray-400 bg-black/70 text-center py-0.5 opacity-0 group-hover:opacity-100 transition">Default</span>
                </button>
                <button class="bg-swatch w-full aspect-[3/2] rounded-lg border-2 border-gray-600 hover:border-white transition overflow-hidden relative group" data-bg="checkered" title="Checkered Flag" onclick="window.setPageBackground('checkered')">
                    <div class="absolute inset-0" style="background-color:#111; background-image: repeating-conic-gradient(#222 0% 25%, #111 0% 50%); background-size: 10px 10px;"></div>
                    <span class="absolute bottom-0 inset-x-0 text-[8px] text-gray-300 bg-black/70 text-center py-0.5 opacity-0 group-hover:opacity-100 transition">üèÅ Flag</span>
                </button>
                <button class="bg-swatch w-full aspect-[3/2] rounded-lg border-2 border-gray-600 hover:border-gray-300 transition overflow-hidden relative group" data-bg="carbon" title="Carbon Fiber" onclick="window.setPageBackground('carbon')">
                    <div class="absolute inset-0" style="background: repeating-linear-gradient(45deg, #0a0a0a, #0a0a0a 2px, #151515 2px, #151515 4px);"></div>
                    <span class="absolute bottom-0 inset-x-0 text-[8px] text-gray-300 bg-black/70 text-center py-0.5 opacity-0 group-hover:opacity-100 transition">Carbon</span>
                </button>
                <button class="bg-swatch w-full aspect-[3/2] rounded-lg border-2 border-gray-600 hover:border-red-400 transition overflow-hidden relative group" data-bg="stripes-red" title="Racing Red" onclick="window.setPageBackground('stripes-red')">
                    <div class="absolute inset-0" style="background: linear-gradient(180deg, #0a0000 0%, #1a0505 40%, #300808 50%, #1a0505 60%, #0a0000 100%);"></div>
                    <div class="absolute top-[42%] left-0 right-0 h-[4px]" style="background:#cc0000;"></div>
                    <div class="absolute top-[55%] left-0 right-0 h-[2px]" style="background:#cc0000;"></div>
                    <span class="absolute bottom-0 inset-x-0 text-[8px] text-red-300 bg-black/70 text-center py-0.5 opacity-0 group-hover:opacity-100 transition">üèéÔ∏è Red</span>
                </button>
                <button class="bg-swatch w-full aspect-[3/2] rounded-lg border-2 border-gray-600 hover:border-cyan-400 transition overflow-hidden relative group" data-bg="night-circuit" title="Night Circuit" onclick="window.setPageBackground('night-circuit')">
                    <div class="absolute inset-0" style="background: radial-gradient(ellipse at 30% 80%, rgba(34,211,238,0.12) 0%, transparent 50%), radial-gradient(ellipse at 70% 20%, rgba(168,85,247,0.1) 0%, transparent 50%), #050a12;"></div>
                    <span class="absolute bottom-0 inset-x-0 text-[8px] text-cyan-300 bg-black/70 text-center py-0.5 opacity-0 group-hover:opacity-100 transition">üåô Night</span>
                </button>
                <button class="bg-swatch w-full aspect-[3/2] rounded-lg border-2 border-gray-600 hover:border-yellow-400 transition overflow-hidden relative group" data-bg="pit-lane" title="Pit Lane" onclick="window.setPageBackground('pit-lane')">
                    <div class="absolute inset-0" style="background: #0c0c0c;"></div>
                    <div class="absolute bottom-0 left-0 right-0 h-[6px]" style="background: repeating-linear-gradient(90deg, #d4a017 0px, #d4a017 6px, #111 6px, #111 12px);"></div>
                    <span class="absolute bottom-0 inset-x-0 text-[8px] text-yellow-300 bg-black/70 text-center py-0.5 opacity-0 group-hover:opacity-100 transition">‚ö†Ô∏è Pit</span>
                </button>
                <button class="bg-swatch w-full aspect-[3/2] rounded-lg border-2 border-gray-600 hover:border-gray-400 transition overflow-hidden relative group" data-bg="tarmac" title="Tarmac" onclick="window.setPageBackground('tarmac')">
                    <div class="absolute inset-0" style="background: #181818; background-image: url('data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%224%22 height=%224%22><rect width=%224%22 height=%224%22 fill=%22%23181818%22/><rect width=%221%22 height=%221%22 x=%220%22 y=%220%22 fill=%22%23202020%22 /><rect width=%221%22 height=%221%22 x=%222%22 y=%222%22 fill=%22%23141414%22 /></svg>');"></div>
                    <div class="absolute top-[48%] left-0 right-0 h-[2px]" style="background: linear-gradient(90deg, transparent 0%, #ffffff44 20%, #ffffff44 80%, transparent 100%);"></div>
                    <span class="absolute bottom-0 inset-x-0 text-[8px] text-gray-300 bg-black/70 text-center py-0.5 opacity-0 group-hover:opacity-100 transition">Tarmac</span>
                </button>
                <button class="bg-swatch w-full aspect-[3/2] rounded-lg border-2 border-gray-600 hover:border-gray-300 transition overflow-hidden relative group" data-bg="black" title="Pure Black" onclick="window.setPageBackground('black')">
                    <div class="absolute inset-0" style="background:#000;"></div>
                    <span class="absolute bottom-0 inset-x-0 text-[8px] text-gray-400 bg-black/70 text-center py-0.5 opacity-0 group-hover:opacity-100 transition">Black</span>
                </button>
                <button class="bg-swatch w-full aspect-[3/2] rounded-lg border-2 border-gray-600 hover:border-blue-400 transition overflow-hidden relative group" data-bg="midnight-blue" title="Midnight Blue" onclick="window.setPageBackground('midnight-blue')">
                    <div class="absolute inset-0" style="background: linear-gradient(180deg, #020820 0%, #0a1640 50%, #020820 100%);"></div>
                    <span class="absolute bottom-0 inset-x-0 text-[8px] text-blue-300 bg-black/70 text-center py-0.5 opacity-0 group-hover:opacity-100 transition">üåä Blue</span>
                </button>
                <button class="bg-swatch w-full aspect-[3/2] rounded-lg border-2 border-gray-600 hover:border-red-400 transition overflow-hidden relative group" data-bg="deep-red" title="Deep Red" onclick="window.setPageBackground('deep-red')">
                    <div class="absolute inset-0" style="background: linear-gradient(180deg, #1a0505 0%, #2d0a0a 50%, #1a0505 100%);"></div>
                    <span class="absolute bottom-0 inset-x-0 text-[8px] text-red-300 bg-black/70 text-center py-0.5 opacity-0 group-hover:opacity-100 transition">üî¥ Red</span>
                </button>
                <button class="bg-swatch w-full aspect-[3/2] rounded-lg border-2 border-gray-600 hover:border-green-400 transition overflow-hidden relative group" data-bg="forest" title="Forest" onclick="window.setPageBackground('forest')">
                    <div class="absolute inset-0" style="background: linear-gradient(180deg, #051a0a 0%, #0a2d15 50%, #051a0a 100%);"></div>
                    <span class="absolute bottom-0 inset-x-0 text-[8px] text-green-300 bg-black/70 text-center py-0.5 opacity-0 group-hover:opacity-100 transition">üå≤ Forest</span>
                </button>
                <button class="bg-swatch w-full aspect-[3/2] rounded-lg border-2 border-gray-600 hover:border-purple-400 transition overflow-hidden relative group" data-bg="purple-night" title="Purple Night" onclick="window.setPageBackground('purple-night')">
                    <div class="absolute inset-0" style="background: linear-gradient(180deg, #0d0520 0%, #1a0a35 50%, #0d0520 100%);"></div>
                    <span class="absolute bottom-0 inset-x-0 text-[8px] text-purple-300 bg-black/70 text-center py-0.5 opacity-0 group-hover:opacity-100 transition">üü£ Purple</span>
                </button>
                <button class="bg-swatch w-full aspect-[3/2] rounded-lg border-2 border-gray-600 hover:border-amber-400 transition overflow-hidden relative group" data-bg="amber-heat" title="Amber Heat" onclick="window.setPageBackground('amber-heat')">
                    <div class="absolute inset-0" style="background: linear-gradient(180deg, #1a1000 0%, #2d1a05 50%, #1a1000 100%);"></div>
                    <span class="absolute bottom-0 inset-x-0 text-[8px] text-amber-300 bg-black/70 text-center py-0.5 opacity-0 group-hover:opacity-100 transition">üî• Amber</span>
                </button>
                <button class="bg-swatch w-full aspect-[3/2] rounded-lg border-2 border-gray-600 hover:border-gray-400 transition overflow-hidden relative group" data-bg="steel" title="Steel" onclick="window.setPageBackground('steel')">
                    <div class="absolute inset-0" style="background: linear-gradient(180deg, #15181e 0%, #1e2530 50%, #15181e 100%);"></div>
                    <span class="absolute bottom-0 inset-x-0 text-[8px] text-gray-300 bg-black/70 text-center py-0.5 opacity-0 group-hover:opacity-100 transition">‚öôÔ∏è Steel</span>
                </button>
                <button class="bg-swatch w-full aspect-[3/2] rounded-lg border-2 border-gray-600 hover:border-cyan-300 transition overflow-hidden relative group" data-bg="neon-grid" title="Neon Grid" onclick="window.setPageBackground('neon-grid')">
                    <div class="absolute inset-0" style="background-color:#050510; background-image: linear-gradient(rgba(0,255,200,0.08) 1px, transparent 1px), linear-gradient(90deg, rgba(0,255,200,0.08) 1px, transparent 1px); background-size: 8px 8px;"></div>
                    <span class="absolute bottom-0 inset-x-0 text-[8px] text-cyan-300 bg-black/70 text-center py-0.5 opacity-0 group-hover:opacity-100 transition">üî≤ Grid</span>
                </button>
                <button class="bg-swatch w-full aspect-[3/2] rounded-lg border-2 border-gray-600 hover:border-orange-400 transition overflow-hidden relative group" data-bg="sunset-racing" title="Sunset Racing" onclick="window.setPageBackground('sunset-racing')">
                    <div class="absolute inset-0" style="background: linear-gradient(180deg, #1a0520 0%, #2d0a15 25%, #4a1a08 50%, #2d0a15 75%, #1a0520 100%);"></div>
                    <span class="absolute bottom-0 inset-x-0 text-[8px] text-orange-300 bg-black/70 text-center py-0.5 opacity-0 group-hover:opacity-100 transition">üåÖ Sunset</span>
                </button>
                <button class="bg-swatch w-full aspect-[3/2] rounded-lg border-2 border-gray-600 hover:border-blue-300 transition overflow-hidden relative group" data-bg="gulf-blue" title="Gulf Blue" onclick="window.setPageBackground('gulf-blue')">
                    <div class="absolute inset-0" style="background: linear-gradient(135deg, #0a2540 0%, #1a4a7a 30%, #0d3560 60%, #0a2540 100%);"></div>
                    <span class="absolute bottom-0 inset-x-0 text-[8px] text-blue-200 bg-black/70 text-center py-0.5 opacity-0 group-hover:opacity-100 transition">üèÜ Gulf</span>
                </button>
                <button class="bg-swatch w-full aspect-[3/2] rounded-lg border-2 border-gray-600 hover:border-green-400 transition overflow-hidden relative group" data-bg="british-green" title="British Racing Green" onclick="window.setPageBackground('british-green')">
                    <div class="absolute inset-0" style="background: linear-gradient(180deg, #0a1a10 0%, #0d2818 30%, #102d1d 50%, #0d2818 70%, #0a1a10 100%);"></div>
                    <span class="absolute bottom-0 inset-x-0 text-[8px] text-green-300 bg-black/70 text-center py-0.5 opacity-0 group-hover:opacity-100 transition">üá¨üáß BRG</span>
                </button>
                <button class="bg-swatch w-full aspect-[3/2] rounded-lg border-2 border-gray-600 hover:border-blue-400 transition overflow-hidden relative group" data-bg="martini-stripe" title="Martini Stripe" onclick="window.setPageBackground('martini-stripe')">
                    <div class="absolute inset-0" style="background: linear-gradient(180deg, #0e0e14 0%, #0e0e14 44%, #1a3a6e 44.5%, #1a3a6e 47%, #cc2222 47.5%, #cc2222 50.5%, #1a3a6e 51%, #1a3a6e 53.5%, #0e0e14 54%, #0e0e14 100%);"></div>
                    <span class="absolute bottom-0 inset-x-0 text-[8px] text-blue-200 bg-black/70 text-center py-0.5 opacity-0 group-hover:opacity-100 transition">üèéÔ∏è Martini</span>
                </button>
                <button class="bg-swatch w-full aspect-[3/2] rounded-lg border-2 border-gray-600 hover:border-cyan-300 transition overflow-hidden relative group" data-bg="arctic-ice" title="Arctic Ice" onclick="window.setPageBackground('arctic-ice')">
                    <div class="absolute inset-0" style="background: linear-gradient(180deg, #0a1520 0%, #102535 30%, #1a3a50 50%, #102535 70%, #0a1520 100%);"></div>
                    <span class="absolute bottom-0 inset-x-0 text-[8px] text-cyan-200 bg-black/70 text-center py-0.5 opacity-0 group-hover:opacity-100 transition">‚ùÑÔ∏è Arctic</span>
                </button>
            </div>
        </div>
    </div>

    <!-- CONTACT US MODAL -->
    <div id="contactUsModal" class="hidden fixed inset-0 bg-navy-950/95 z-[120] flex items-center justify-center p-4">
        <div class="bg-navy-900 border border-gray-700 rounded-xl p-6 max-w-md w-full shadow-2xl">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-lg font-bold text-ice flex items-center gap-2">
                    <i class="fas fa-envelope"></i> <span data-i18n="contactUs">Contact Us</span>
                </h2>
                <button onclick="window.closeContactUsModal()" class="text-gray-400 hover:text-white text-xl">&times;</button>
            </div>

            <div class="flex gap-2 mb-3">
                <button onclick="window.showFeedbackTab('bug')" id="bugReportTabBtn" class="flex-1 bg-red-900/50 hover:bg-red-800 border border-red-500/50 text-red-200 font-bold py-2 rounded transition text-sm" data-i18n="bugReport">Report Bug</button>
                <button onclick="window.showFeedbackTab('feature')" id="featureTabBtn" class="flex-1 bg-blue-900/50 hover:bg-blue-800 border border-blue-500/50 text-blue-200 font-bold py-2 rounded transition text-sm" data-i18n="featureSuggestion">Suggest Feature</button>
            </div>

            <div id="feedbackForm" class="bg-navy-800 border border-gray-600 p-3 rounded">
                <div class="text-xs text-gray-400 font-bold mb-2" id="feedbackTitle" data-i18n="bugReportTitle">Bug Report</div>
                <textarea id="feedbackText" class="input-field text-xs mb-2 resize-none" rows="4" data-i18n="describeIssue" placeholder="Describe the issue or suggestion..."></textarea>
                <button onclick="window.submitFeedback()" class="w-full bg-gradient-to-r from-neon to-green-500 hover:from-green-400 hover:to-green-600 text-black font-bold py-2 rounded transition" data-i18n="send">Send</button>
            </div>
        </div>
    </div>

    <!-- PRO UPGRADE MODAL -->
    <div id="proUpgradeModal" class="hidden fixed inset-0 bg-navy-950/95 z-[130] flex items-center justify-center p-4">
        <div class="bg-navy-900 border border-gold/50 rounded-xl p-6 max-w-md w-full shadow-2xl">
            <div class="text-center mb-4">
                <div class="text-4xl mb-2">‚≠ê</div>
                <h2 class="text-xl font-bold text-gold" data-i18n="proUpgradeTitle">Upgrade to Pro</h2>
                <p class="text-sm text-gray-400 mt-2" data-i18n="proUpgradeMsg">Unlock Live Timing, AI Strategy, Squads, unlimited drivers & themes, and more!</p>
                <div id="proGateFeature" class="text-xs text-red-400 mt-1 font-bold"></div>
            </div>

            <!-- Step 1: Buy -->
            <div class="bg-navy-950/50 rounded-lg p-4 mb-4 border border-gray-700/50">
                <p class="text-xs font-bold text-gray-300 mb-2">‚ë† Purchase a license (<span id="proPriceOriginal">$19</span> one-time)</p>
                <a id="proBuyLink" href="https://paypal.me/holylandracers/19" target="_blank" rel="noopener"
                   class="block w-full text-center bg-gradient-to-r from-blue-600 to-blue-500 text-white font-bold py-2.5 rounded-lg hover:from-blue-500 hover:to-blue-400 transition text-sm">
                    üí≥ Buy with PayPal ‚Äî <span id="proBuyPrice">$19</span>
                </a>
                <p class="text-[10px] text-gray-500 mt-1.5 text-center">After payment, you'll receive your license key by email within minutes.</p>

                <!-- Coupon Code -->
                <div class="mt-3 pt-3 border-t border-gray-700/50">
                    <button onclick="document.getElementById('couponSection').classList.toggle('hidden')" class="text-xs text-cyan-400 hover:text-cyan-300 transition cursor-pointer" data-i18n="proHaveCoupon">üéüÔ∏è Have a coupon code?</button>
                    <div id="couponSection" class="hidden mt-2">
                        <div class="flex gap-2">
                            <input type="text" id="couponInput" placeholder="SAVE-XXXXXX" class="input-field text-xs flex-1 font-mono tracking-wide uppercase" style="text-transform:uppercase;">
                            <button onclick="window.applyCoupon()" id="applyCouponBtn" class="bg-cyan-600 text-white font-bold px-3 py-1.5 rounded transition hover:bg-cyan-500 text-xs whitespace-nowrap" data-i18n="proApplyCoupon">Apply</button>
                        </div>
                        <div id="couponResult" class="hidden text-xs mt-1.5 text-center font-bold"></div>
                    </div>
                </div>

                <!-- Coupon applied banner -->
                <div id="couponAppliedBanner" class="hidden mt-3 p-2 bg-green-900/30 border border-green-500/30 rounded-lg text-center">
                    <span class="text-green-400 text-xs font-bold" id="couponAppliedText"></span>
                    <button onclick="window.removeCoupon()" class="text-red-400 text-xs ml-2 hover:text-red-300">‚úï Remove</button>
                </div>
            </div>

            <!-- Step 2: Enter key -->
            <div class="space-y-3">
                <p class="text-xs font-bold text-gray-300">‚ë° Already have a key? Enter it below:</p>
                <div class="flex gap-2">
                    <input type="text" id="proLicenseInput" data-i18n="proEnterKey" placeholder="STRAT-XXXX-XXXX-XXXX-XXXX" class="input-field text-sm flex-1 font-mono tracking-wide">
                    <button onclick="window.handleActivatePro()" class="bg-gradient-to-r from-gold to-amber-500 text-black font-bold px-4 py-2 rounded transition hover:from-amber-400 hover:to-gold text-sm whitespace-nowrap" data-i18n="proActivate">Activate</button>
                </div>
                <div id="proActivateError" class="hidden text-red-400 text-xs text-center"></div>
                <div id="proActivateSuccess" class="hidden text-green-400 text-xs text-center font-bold"></div>
            </div>

            <button onclick="document.getElementById('proUpgradeModal').classList.add('hidden')" class="w-full bg-navy-800 text-gray-400 py-2 rounded mt-4 hover:bg-navy-700 transition text-sm">Close</button>
        </div>
    </div>

    <!-- ONBOARDING OVERLAY -->
    <div id="onboardingOverlay" class="hidden fixed inset-0 bg-black/80 z-[140] flex items-center justify-center p-4">
        <div class="bg-navy-900 border border-ice/50 rounded-xl p-6 max-w-sm w-full shadow-2xl text-center">
            <div id="onboardStep" class="transition-opacity duration-300">
                <div id="onboardEmoji" class="text-5xl mb-3">üèÅ</div>
                <h2 id="onboardTitle" class="text-xl font-bold text-ice mb-2" data-i18n="onboardWelcome">Welcome to Strateger!</h2>
                <p id="onboardText" class="text-sm text-gray-400 mb-4"></p>
                <div id="onboardDots" class="flex justify-center gap-2 mb-4">
                    <span class="w-2 h-2 rounded-full bg-ice"></span>
                    <span class="w-2 h-2 rounded-full bg-gray-600"></span>
                    <span class="w-2 h-2 rounded-full bg-gray-600"></span>
                    <span class="w-2 h-2 rounded-full bg-gray-600"></span>
                </div>
            </div>
            <div class="flex gap-2">
                <button onclick="window.skipOnboarding()" class="flex-1 bg-navy-800 text-gray-400 py-2 rounded hover:bg-navy-700 transition text-sm" data-i18n="onboardSkip">Skip</button>
                <button onclick="window.nextOnboardStep()" id="onboardNextBtn" class="flex-1 bg-ice text-navy-950 font-bold py-2 rounded hover:bg-cyan-300 transition text-sm" data-i18n="onboardNext">Next</button>
            </div>
        </div>
    </div>

    <!-- UNDO PIT TOAST (fixed bottom-center) -->
    <div id="undoPitToast" class="hidden fixed bottom-6 left-1/2 -translate-x-1/2 z-[100] bg-navy-900 border border-amber-500/50 text-white px-4 py-3 rounded-xl shadow-2xl flex items-center gap-3 animate-slide-up">
        <span class="text-sm font-bold" data-i18n="undoPit">Undo Pit</span>
        <span id="undoPitCountdown" class="text-xs text-amber-400 font-mono">10s</span>
        <button onclick="window.executeUndoPit()" class="bg-amber-500 text-black font-bold px-3 py-1 rounded text-sm hover:bg-amber-400 transition" data-i18n="undoCountdown">Undo</button>
    </div>

    <!-- TOAST NOTIFICATION CONTAINER -->
    <div id="toastContainer" class="fixed top-14 right-3 z-[200] flex flex-col gap-2 pointer-events-none" style="max-width:380px;"></div>

    <!-- PWA INSTALL BANNER -->
    <div id="installBanner" class="hidden fixed bottom-4 left-1/2 -translate-x-1/2 z-[150] bg-navy-900 border border-ice/50 text-white px-4 py-3 rounded-xl shadow-2xl flex items-center gap-3 max-w-sm w-[calc(100%-2rem)]">
        <div class="text-2xl">üì≤</div>
        <div class="flex-1">
            <div class="text-sm font-bold text-ice" data-i18n="installApp">Install Strateger</div>
            <div class="text-[10px] text-gray-400" data-i18n="installDesc">Add to home screen for the best experience</div>
        </div>
        <button onclick="window.installPWA()" class="bg-ice text-navy-950 font-bold px-3 py-1.5 rounded text-xs hover:bg-cyan-300 transition" data-i18n="install">Install</button>
        <button onclick="window.dismissInstall()" class="text-gray-500 hover:text-white text-lg leading-none">&times;</button>
    </div>

    <!-- RACE SUMMARY MODAL -->
    <div id="raceSummaryModal" class="hidden fixed inset-0 bg-black/90 z-[130] flex items-center justify-center p-3 overflow-y-auto">
        <div class="bg-navy-900 border border-ice/40 rounded-2xl p-5 max-w-lg w-full shadow-2xl">
            <div class="text-center mb-4">
                <div class="text-5xl mb-2">üèÅ</div>
                <h2 class="text-2xl font-black text-ice tracking-wide" data-i18n="raceFinished">RACE FINISHED</h2>
            </div>
            <!-- Race info row -->
            <div id="summaryRaceInfo" class="flex justify-around text-center text-xs text-gray-400 border-b border-gray-700 pb-3 mb-3"></div>
            <!-- Driver stats table -->
            <div id="summaryDriverStats" class="space-y-2 mb-4"></div>
            <!-- Pit stop log -->
            <div id="summaryPitLog" class="mb-4"></div>
            <!-- Actions -->
            <div class="flex gap-2 mt-4">
                <button onclick="window.shareRaceSummary()" class="flex-1 bg-ice/20 border border-ice/40 text-ice font-bold py-2 rounded-lg text-sm hover:bg-ice/30 transition flex items-center justify-center gap-2">
                    <i class="fas fa-share-alt"></i> <span data-i18n="share">Share</span>
                </button>
                <button onclick="document.getElementById('raceSummaryModal').classList.add('hidden')" class="flex-1 bg-navy-800 text-gray-300 font-bold py-2 rounded-lg text-sm hover:bg-navy-700 transition" data-i18n="close">Close</button>
            </div>
        </div>
    </div>

    <!-- Confirm Modal (replaces native confirm()) -->
    <div id="confirmModal" class="hidden fixed inset-0 bg-black/85 z-[250] flex items-center justify-center p-4" onclick="if(event.target===this)window.dismissConfirmModal()">
        <div class="bg-navy-900 border border-gray-700 rounded-2xl shadow-2xl max-w-sm w-full p-5 space-y-3">
            <div id="confirmTitle" class="text-lg font-bold text-white"></div>
            <div id="confirmBody" class="text-sm text-gray-400"></div>
            <div id="confirmQuestion" class="text-sm text-ice font-semibold"></div>
            <div class="flex gap-3 pt-2">
                <button onclick="window.dismissConfirmModal()" class="flex-1 bg-navy-800 border border-gray-600 text-gray-300 font-bold py-2.5 rounded-lg text-sm hover:bg-navy-700 transition">Cancel</button>
                <button id="confirmOkBtn" onclick="window.executeConfirmAction()" class="flex-1 bg-red-600 hover:bg-red-500 text-white font-bold py-2.5 rounded-lg text-sm transition">Confirm</button>
            </div>
        </div>
    </div>

    <script src="js/state.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/network.js"></script>
    <script src="js/strategy.js"></script>
    <script src="js/live-timing.js"></script>
    <script src="js/ui.js"></script>
    <script src="js/main.js"></script>
</body>
</html>