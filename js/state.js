// ==========================================
// ğŸŒ GLOBAL STATE & CONFIGURATION
// ==========================================

// --- PeerJS & Networking Globals ---
window.peer = null;
window.conn = null;
window.connections = [];
window.myId = null;
window.role = null;

// --- Application Config & State ---
window.config = {}; 
window.drivers = []; 
window.savedHostConfig = null;
window.savedConfigPanelState = null;

// --- Timers & Intervals ---
window.raceInterval = null;
window.pitInterval = null;
window.liveTimingInterval = null;
window.proxyFetchInterval = null;
window.connectionRetries = 0;
window.MAX_RETRIES = 3;

// --- Constants ---
window.RACE_STATE_KEY = 'strateger_race_state';
window.liveTimingManager = null;
window.syncedTimes = null;

// --- Race Logic State ---
window.state = { 
    isRunning: false, 
    mode: 'normal', 
    trackCondition: 'dry',
    isRain: false, 
    currentDriverIdx: 0, 
    pitCount: 0, 
    startTime: 0, 
    stintStart: 0, 
    pitStart: 0, 
    isInPit: false, 
    fuelStart: 0, 
    stintOffset: 0, 
    activeSquad: 'A', 
    nextDriverIdx: 1, 
    targetStintMs: 0, 
    squadsActive: false,
    pendingPitEntry: false,
    globalStintNumber: 1,
    raceSaved: false,
    stintTargets: [],
    deltaHistory: []
};

// --- Live Timing Configuration ---
window.liveTimingConfig = {
    url: '',
    teamName: '',
    enabled: false,
    demoMode: false
};

window.searchConfig = {
    teamName: '',
    driverName: '',
    kartNumber: ''
};

window.liveData = {
    position: null,
    previousPosition: null,
    lastLap: null,
    bestLap: null,
    laps: null,
    gapToLeader: null,
    competitors: []
};

window.demoState = {
    competitors: [],
    updateInterval: null
};

// --- AI & Strategy Config ---
window.aiStrategyConfig = {
    weatherCondition: 'dry',
    instructions: '',
    starterDriverIdx: 0,
    useAI: false
};

window.cachedStrategy = null;
window.previewData = null;

// ==========================================
// ğŸŒ INTERNATIONALIZATION (I18N)
// ==========================================
window.currentLang = 'en';

window.translations = {
    en: {
        offline: 'Offline',
        subtitle: 'Endurance Race Strategy Manager',
        host: 'Host',
        hostDesc: 'Manage the race',
        viewer: 'Viewer',
        viewerDesc: 'Watch live',
        yourCode: 'Your Code:',
        retry: 'Retry',
        raceSettings: 'âš™ï¸ Race Settings',
        liveTiming: 'Live Timing (Optional)',
        liveTimingUrl: 'Live Timing URL (APEX/RaceFacer)',
        searchBy: 'Search by:',
        team: 'Team',
        kart: 'Kart',
        driver: 'Driver',
        testConnection: 'Test',
        demo: 'Demo',
        manual: 'Manual',
        duration: 'Duration (hours)',
        reqStops: 'Required Stops',
        minStint: 'Min Stint (min)',
        maxStint: 'Max Stint (min)',
        driverLimits: 'Driver Limits (0 = no limit)',
        minDrive: 'Min Drive',
        maxDrive: 'Max Drive',
        pitTime: 'Pit Time (sec)',
        releaseBuffer: 'Release Buffer (sec)',
        doubleStint: 'Double',
        fuel: 'Fuel',
        squads: 'Squads',
        fuelTankTime: 'Fuel Tank Time (min)',
        driversSetup: 'Drivers (mark starter)',
        startRace: 'Start Race (Host)',
        enterCode: 'Enter Host Code:',
        connect: 'Connect',
        disconnect: 'Disconnect',
        code: 'Code:',
        synced: 'Synced',
        simResultPattern: "âœ… {stints} stints Ã— ~{avg}min = {totalDrive}min drive\nğŸ Pit stops: {stops} Ã— {pitTime}s = {totalPit}min\n{note}",
        stdStrategy: "Standard strategy - maximize stint length",
        shortStrategy: "Short strategy - minimize stops",
        longStrategy: "Long strategy - save fuel/tires",
        aiStrategyPrefix: "ğŸ¤– AI Plan: ",
        raceTime: 'Race Time',
        pitStops: 'Pit Stops',
        dry: 'Dry',
        wet: 'Wet',
        drying: 'Drying',
        targetStint: 'Target Stint',
        buildTime: 'Build Time',
        stintTime: 'Stint Time',
        currentDriver: 'Current Driver',
        activeSquad: 'Active Squad:',
        resting: 'Resting:',
        push: 'Push',
        problem: 'Problem',
        night: 'Night',
        resetMode: 'â†©ï¸ Reset Mode',
        driverHeader: 'Driver',
        stintsHeader: 'St.',
        totalHeader: 'Total',
        nextDriver: 'Next Driver',
        enterPit: 'ğŸ Enter Pit',
        inPit: 'IN PIT',
        nextDriverIn: 'Next Driver:',
        refuel: 'Kart Change / Refuel?',
        notifyDriver: 'Notify Driver',
        notified: 'Notified - Waiting for line cross',
        wait: 'Wait...',
        cancelPit: 'Cancel Pit Entry',
        manualInput: 'Manual Input',
        position: 'Position',
        laps: 'Laps',
        lastLap: 'Last Lap',
        bestLap: 'Best Lap',
        gap: 'Gap to Leader',
        inPitNow: 'Currently in Pit',
        apply: 'Apply',
        cancel: 'Cancel',
        waitingData: 'Waiting for data...',
        proxyData: 'Proxy Data:',
        liveView: 'Live View',
        connecting: 'Connecting...',
        connected: 'Connected',
        waitingRace: 'Connected! Waiting for race...',
        disconnected: 'Disconnected',
        enterUrl: 'âŒ Enter URL',
        enterValue: 'âŒ Enter',
        testing: 'ğŸ”„ Testing...',
        found: 'âœ… Found! Position:',
        notFound: 'âš ï¸ Not found - check details or use iframe',
        error: 'âŒ Error:',
        confirmEarlyPit: 'Window closed! Enter anyway?',
        confirmExit: 'âœ… Confirm Line Cross',
        timeExceeded: 'ğŸš¨ Time Exceeded!',
        problemQuick: 'ğŸ¢ Problem - Quick Entry!',
        pushExtend: 'ğŸ”¥ Extending! Build time',
        nearLimit: 'âš ï¸ Near limit!',
        targetWindow: 'âœ… Target Window',
        overExtend: 'ğŸ“¥ Over Extended',
        nightActive: 'ğŸŒ™ Night Active',
        pushActive: 'ğŸ”¥ Push Active',
        problemActive: 'ğŸ¢ Problem Active',
        teamNotFound: 'Team not found',
        connectionIssues: 'Connection issues',
        usingIframe: 'Using iframe',
        connectionFailed: 'Connection failed',
        stopped: 'Stopped',
        racePreview: 'Race Strategy Preview',
        raceStartTime: 'Race Start Time',
        driverSchedule: 'Driver Schedule',
        strategySummary: 'Strategy Summary',
        editStrategy: 'Back to Setup',
        saveStrategy: 'Save Strategy',
        previewStrategy: 'Preview Strategy',
        stopLiveTiming: 'Stop',
        activeRaceFound: 'Active Race Found!',
        raceInProgress: 'A race is currently in progress',
        timeRemaining: 'Time Remaining',
        continueRace: 'Continue Race',
        discardRace: 'Discard & Start New',
        raceWarning: 'Discarding will permanently delete this race data',
        confirmDiscard: 'Are You Sure?',
        confirmDiscardMessage: 'This will permanently delete the active race. This action cannot be undone.',
        yesDiscard: 'Yes, Discard Race',
        noKeepRace: 'No, Keep Race',
        loadStrategy: 'Load Saved Strategy',
        savedStrategies: 'ğŸ“š Saved Strategies',
        noSavedStrategies: 'No saved strategies yet',
        strategyName: 'Strategy Name:',
        strategySaved: 'âœ… Strategy saved:',
        aiAssistant: 'ğŸ¤– AI Strategy Assistant',
        expectedConditions: 'Expected Conditions:',
        mixed: 'Mixed',
        strategyInstructions: 'Strategy Instructions:',
        aiPlaceholder: "e.g., 'Focus double stints during night for Squad A', 'Keep driver X fresh for final stints'...",
        generateAi: 'ğŸ¤– Generate AI Strategy',
        analyzing: 'ğŸ¤– Analyzing strategy...',
        aiApplied: 'âœ… AI strategy applied!',
        aiError: 'âŒ Error generating strategy',
        pitClosedStart: 'ğŸš« Pit Closed Start (min)',
        pitClosedEnd: 'ğŸš« Pit Closed End (min)',
        finish: 'Finish',
        raceFinished: 'ğŸ Race Finished!',
        savedToDb: 'âœ… Strategy saved to database',
        safetyWarning: 'âš ï¸ Safety Warning',
        googleConnect: 'Google Connect',
        signInGoogle: 'Sign in with Google',
        emailTeam: 'Email Team',
        addCalendar: 'Add to Calendar',
        shareStrategy: 'Share Strategy',
        checkAvailability: 'Check Availability',
        recipients: 'Recipients (comma separated)',
        emailSubject: 'Subject',
        message: 'Message',
        attachStrategy: 'Attach current strategy',
        sendEmail: 'Send Email',
        addToCalendar: 'Add to Google Calendar',
        eventTitle: 'Event Title',
        startDate: 'Start Date',
        startTime: 'Start Time',
        location: 'Location',
        inviteDrivers: 'Invite Drivers (emails)',
        addReminder: 'Add reminder (1 day before)',
        createEvent: 'Create Event',
        recipientsHistory: 'Recent recipients found',
        eventsFound: 'Events found on this date:',
        noEvents: 'No events found. You are free!',
        raceStart: 'Race Start',
        raceEnd: 'Race End',
        totalDriving: 'Total Driving',
        avgStint: 'Avg Stint',
        stintCount: 'Stints',
        localhostError: 'AI/DB features require Netlify environment (or netlify dev).',
        loading: 'Loading...',
        strategyLoaded: 'Strategy Loaded!',
        saveSuccess: 'Saved Successfully',
        scheduleTitle: 'Schedule',
        summaryTitle: 'Driver Summary'
    },
    he: {
        offline: '×œ× ××—×•×‘×¨',
        subtitle: '×× ×”×œ ××¡×˜×¨×˜×’×™×™×ª ××™×¨×•×¦×™ ×¡×™×‘×•×œ×ª',
        host: '×××¨×—',
        hostDesc: '× ×”×œ ××ª ×”××™×¨×•×¥',
        viewer: '×¦×•×¤×”',
        viewerDesc: '×¦×¤×” ×‘×©×™×“×•×¨ ×—×™',
        yourCode: '×”×§×•×“ ×©×œ×š:',
        retry: '× ×¡×” ×©×•×‘',
        raceSettings: 'âš™ï¸ ×”×’×“×¨×•×ª ××™×¨×•×¥',
        liveTiming: 'Live Timing (××•×¤×¦×™×•× ×œ×™)',
        liveTimingUrl: '×§×™×©×•×¨ Live Timing (APEX/RaceFacer)',
        searchBy: '×—×¤×© ×œ×¤×™:',
        team: '×§×‘×•×¦×”',
        kart: '×§××¨×˜',
        driver: '× ×”×’',
        testConnection: '×‘×“×•×§',
        demo: '×“××•',
        manual: '×™×“× ×™',
        duration: '××©×š (×©×¢×•×ª)',
        reqStops: '×¢×¦×™×¨×•×ª ×—×•×‘×”',
        minStint: '××™× \' ×¡×˜×™× ×˜ (×“×§\')',
        maxStint: '××§×¡\' ×¡×˜×™× ×˜ (×“×§\')',
        driverLimits: '×’×‘×•×œ×•×ª × ×”×’ (0 = ×œ×œ× ×”×’×‘×œ×”)',
        minDrive: '××™× ×™××•× × ×”×™×’×”',
        maxDrive: '××§×¡×™××•× × ×”×™×’×”',
        pitTime: '×–××Ÿ ×¤×™×˜×¡ (×©× ×™×•×ª)',
        releaseBuffer: '×”×§×“××ª ×”×ª×¨××” (×©× \')',
        doubleStint: '×“××‘×œ',
        fuel: '×“×œ×§',
        squads: '×—×•×œ×™×•×ª',
        fuelTankTime: '×–××Ÿ ××™×›×œ ×“×œ×§ (×“×§\')',
        driversSetup: '×”×’×“×¨×ª × ×”×’×™× (×¡××Ÿ ××–× ×§)',
        startRace: '×”×ª×—×œ ××¨×•×¥ (×× ×”×œ)',
        enterCode: '×”×›× ×¡ ×§×•×“ ×××¨×—:',
        connect: '×”×ª×—×‘×¨',
        disconnect: '×”×ª× ×ª×§',
        code: '×§×•×“:',
        synced: '××¡×•× ×›×¨×Ÿ',
        simResultPattern: "âœ… {stints} ×¡×˜×™× ×˜×™× Ã— ~{avg} ×“×§' = {totalDrive} ×“×§' × ×”×™×’×”\nğŸ ×¢×¦×™×¨×•×ª ×¤×™×˜: {stops} Ã— {pitTime} ×©× ×™×•×ª = {totalPit} ×“×§'\n{note}",
        stdStrategy: "××¡×˜×¨×˜×’×™×” ×¡×˜× ×“×¨×˜×™×ª - ××§×¡×•× ××•×¨×š ×¡×˜×™× ×˜",
        shortStrategy: "××¡×˜×¨×˜×’×™×” ×§×¦×¨×” - ××™× ×™××•× ×¢×¦×™×¨×•×ª",
        longStrategy: "××¡×˜×¨×˜×’×™×” ××¨×•×›×” - ×—×™×¡×›×•×Ÿ ×‘×“×œ×§/×¦××™×’×™×",
        aiStrategyPrefix: "ğŸ¤– ×ª×•×›× ×™×ª AI: ",
        raceTime: '×–××Ÿ ××™×¨×•×¥',
        pitStops: '×¢×¦×™×¨×•×ª ×¤×™×˜×¡',
        dry: '×™×‘×©',
        wet: '×’×©×',
        drying: '××ª×™×™×‘×©',
        targetStint: '×™×¢×“ ×¡×˜×™× ×˜ × ×•×›×—×™',
        buildTime: '×¦×‘×•×¨ ×–××Ÿ',
        stintTime: '×–××Ÿ ×¡×˜×™× ×˜',
        currentDriver: '× ×”×’ × ×•×›×—×™',
        activeSquad: '×—×•×œ×™×” ×¤×¢×™×œ×”:',
        resting: '× ×—×™×:',
        push: '×§×¦×‘',
        problem: '×ª×§×œ×”',
        night: '×œ×™×œ×”',
        resetMode: 'â†©ï¸ ××™×¤×•×¡ ××¦×‘',
        driverHeader: '× ×”×’',
        stintsHeader: '×¡×˜\'',
        totalHeader: '×¡×”"×›',
        nextDriver: '× ×”×’ ×”×‘×',
        enterPit: 'ğŸ ×›× ×™×¡×” ×œ×¤×™×˜×¡',
        inPit: '×‘×¤×™×˜×¡',
        nextDriverIn: '× ×”×’ × ×›× ×¡:',
        refuel: '×”×•×—×œ×£ ×§××¨×˜ / ×ª×“×œ×•×§?',
        notifyDriver: '×”×•×“×¢ ×œ× ×”×’ ×œ×”×ª×›×•× ×Ÿ',
        notified: '×”×•×“×¢×” × ×©×œ×—×” - ×××ª×™×Ÿ ×œ×—×¦×™×™×ª ×§×•',
        wait: '×”××ª×Ÿ...',
        cancelPit: '×‘×˜×œ ×›× ×™×¡×” ×œ×¤×™×˜×¡',
        manualInput: '×”×–× ×” ×™×“× ×™×ª',
        position: '××™×§×•×',
        laps: '×”×§×¤×•×ª',
        lastLap: '×”×§×¤×” ××—×¨×•× ×”',
        bestLap: '×”×§×¤×” ×”×˜×•×‘×”',
        gap: '×¤×¢×¨ ×××•×‘×™×œ',
        inPitNow: '×›×¨×’×¢ ×‘×¤×™×˜×¡',
        apply: '×”×—×œ',
        cancel: '×‘×™×˜×•×œ',
        waitingData: '×××ª×™×Ÿ ×œ× ×ª×•× ×™×...',
        proxyData: '× ×ª×•× ×™ ×¤×¨×•×§×¡×™:',
        liveView: '×ª×¦×•×’×” ×—×™×”',
        connecting: '××ª×—×‘×¨...',
        connected: '××—×•×‘×¨',
        waitingRace: '××—×•×‘×¨! ×××ª×™×Ÿ ×œ×ª×—×™×œ×ª ××¨×•×¥...',
        disconnected: '× ×•×ª×§ ××”×××¨×—',
        enterUrl: 'âŒ ×”×›× ×¡ ×§×™×©×•×¨',
        enterValue: 'âŒ ×”×›× ×¡',
        testing: 'ğŸ”„ ×‘×•×“×§...',
        found: 'âœ… × ××¦×! ××™×§×•×:',
        notFound: 'âš ï¸ ×œ× × ××¦× - ×‘×“×•×§ ××ª ×”×¤×¨×˜×™× ××• ×”×©×ª××© ×‘-iframe',
        error: 'âŒ ×©×’×™××”:',
        confirmEarlyPit: '×—×œ×•×Ÿ ×¡×’×•×¨! ×œ×”×™×›× ×¡?',
        confirmExit: 'âœ… ××©×¨ ×—×¦×™×™×ª ×§×•',
        timeExceeded: 'ğŸš¨ ×—×¨×™×’×ª ×–××Ÿ!',
        problemQuick: 'ğŸ¢ ×ª×§×œ×” - ×›× ×™×¡×” ××”×™×¨×”!',
        pushExtend: 'ğŸ”¥ ×××¨×™×›×™×! ×¦×‘×•×¨ ×–××Ÿ',
        nearLimit: 'âš ï¸ ×§×¨×•×‘ ×œ×’×‘×•×œ!',
        targetWindow: 'âœ… ×—×œ×•×Ÿ ×™×¢×“',
        overExtend: 'ğŸ“¥ ×”××¨×›×ª ×™×ª×¨',
        nightActive: 'ğŸŒ™ ×œ×™×œ×” ×¤×¢×™×œ',
        pushActive: 'ğŸ”¥ ×§×¦×‘ ×¤×¢×™×œ',
        problemActive: 'ğŸ¢ ×ª×§×œ×” ×¤×¢×™×œ',
        teamNotFound: '×§×‘×•×¦×” ×œ× × ××¦××”',
        connectionIssues: '×‘×¢×™×•×ª ×—×™×‘×•×¨',
        usingIframe: '××©×ª××© ×‘-iframe',
        connectionFailed: '×”×—×™×‘×•×¨ × ×›×©×œ',
        stopped: '× ×¢×¦×¨',
        racePreview: '×ª×¦×•×’×” ××§×“×™××” ×©×œ ××¡×˜×¨×˜×’×™×”',
        raceStartTime: '×©×¢×ª ×”×ª×—×œ×ª ×”××™×¨×•×¥',
        driverSchedule: '×œ×•×— ×–×× ×™× × ×”×’×™×',
        strategySummary: '×¡×™×›×•× ××¡×˜×¨×˜×’×™×”',
        editStrategy: '×—×–×¨×” ×œ××¡×š ×¨××©×™',
        saveStrategy: '×©××•×¨ ××¡×˜×¨×˜×’×™×”',
        previewStrategy: '×ª×¦×•×’×” ××§×“×™××”',
        stopLiveTiming: '×¢×¦×•×¨',
        activeRaceFound: '× ××¦× ××™×¨×•×¥ ×¤×¢×™×œ!',
        raceInProgress: '××™×¨×•×¥ ××ª×§×™×™× ×›×¢×ª',
        timeRemaining: '×–××Ÿ × ×•×ª×¨',
        continueRace: '×”××©×š ××™×¨×•×¥',
        discardRace: '××—×§ ×•×”×ª×—×œ ×—×“×©',
        raceWarning: '××—×™×§×” ×ª××—×§ ×œ×¦××™×ª×•×ª ××ª × ×ª×•× ×™ ×”××™×¨×•×¥',
        confirmDiscard: '×”×× ××ª×” ×‘×˜×•×—?',
        confirmDiscardMessage: '×¤×¢×•×œ×” ×–×• ×ª××—×§ ×œ×¦××™×ª×•×ª ××ª ×”××™×¨×•×¥ ×”×¤×¢×™×œ. ×œ× × ×™×ª×Ÿ ×œ×‘×˜×œ ×¤×¢×•×œ×” ×–×•.',
        yesDiscard: '×›×Ÿ, ××—×§ ××™×¨×•×¥',
        noKeepRace: '×œ×, ×©××•×¨ ××™×¨×•×¥',
        loadStrategy: '×˜×¢×Ÿ ××¡×˜×¨×˜×’×™×” ×©××•×¨×”',
        savedStrategies: 'ğŸ“š ××¡×˜×¨×˜×’×™×•×ª ×©××•×¨×•×ª',
        noSavedStrategies: '××™×Ÿ ××¡×˜×¨×˜×’×™×•×ª ×©××•×¨×•×ª ×¢×“×™×™×Ÿ',
        strategyName: '×©× ×”××¡×˜×¨×˜×’×™×”:',
        strategySaved: 'âœ… ×”××¡×˜×¨×˜×’×™×” × ×©××¨×”:',
        aiAssistant: 'ğŸ¤– ×¢×•×–×¨ ××¡×˜×¨×˜×’×™×” (AI)',
        expectedConditions: '×ª× ××™× ×¦×¤×•×™×™×:',
        mixed: '××¢×•×¨×‘',
        strategyInstructions: '×”×•×¨××•×ª ×œ××œ×’×•×¨×™×ª×:',
        aiPlaceholder: "×œ×“×•×’××”: '×ª×Ÿ ×“××‘×œ ×¡×˜×™× ×˜×™× ×‘×œ×™×œ×” ×œ×—×•×œ×™×” ×', '×©××•×¨ ××ª × ×”×’ X ×œ×¡×•×£'...",
        generateAi: 'ğŸ¤– ×¦×•×¨ ××¡×˜×¨×˜×’×™×”',
        analyzing: 'ğŸ¤– ×× ×ª×— ××¡×˜×¨×˜×’×™×”...',
        aiApplied: 'âœ… ××¡×˜×¨×˜×’×™×” ×”×•×—×œ×”!',
        aiError: 'âŒ ×©×’×™××” ×‘×™×¦×™×¨×ª ××¡×˜×¨×˜×’×™×”',
        pitClosedStart: 'ğŸš« ×¤×™×˜×¡ ×¡×’×•×¨ ×‘×”×ª×—×œ×” (×“×§\')',
        pitClosedEnd: 'ğŸš« ×¤×™×˜×¡ ×¡×’×•×¨ ×‘×¡×•×£ (×“×§\')',
        finish: '×¡×™×•×',
        raceFinished: 'ğŸ ×”××™×¨×•×¥ ×”×¡×ª×™×™×!',
        savedToDb: 'âœ… × ×©××¨ ×œ××¡×“ ×”× ×ª×•× ×™×',
        safetyWarning: 'âš ï¸ ××–×”×¨×ª ×‘×˜×™×—×•×ª',
        googleConnect: '×”×ª×—×‘×¨×•×ª Google',
        signInGoogle: '×”×ª×—×‘×¨ ×¢× Google',
        emailTeam: '×©×œ×— ××™×™×œ ×œ×¦×•×•×ª',
        addCalendar: '×”×•×¡×£ ×œ×™×•××Ÿ',
        shareStrategy: '×©×ª×£ ××¡×˜×¨×˜×’×™×”',
        checkAvailability: '×‘×“×•×§ ×–××™× ×•×ª',
        recipients: '× ××¢× ×™× (××•×¤×¨×“×™× ×‘×¤×¡×™×§)',
        emailSubject: '× ×•×©×',
        message: '×”×•×“×¢×”',
        attachStrategy: '×¦×¨×£ ××¡×˜×¨×˜×’×™×” × ×•×›×—×™×ª',
        sendEmail: '×©×œ×— ××™×™×œ',
        addToCalendar: '×”×•×¡×£ ×œ×™×•××Ÿ Google',
        eventTitle: '×›×•×ª×¨×ª ××™×¨×•×¢',
        startDate: '×ª××¨×™×š ×”×ª×—×œ×”',
        startTime: '×©×¢×ª ×”×ª×—×œ×”',
        location: '××™×§×•×',
        inviteDrivers: '×”×–××Ÿ × ×”×’×™× (××™××™×™×œ×™×)',
        addReminder: '×”×•×¡×£ ×ª×–×›×•×¨×ª (×™×•× ×œ×¤× ×™)',
        createEvent: '×¦×•×¨ ××™×¨×•×¢',
        recipientsHistory: '× ××¦××• × ××¢× ×™× ××—×¨×•× ×™×',
        eventsFound: '××™×¨×•×¢×™× ×‘×ª××¨×™×š ×–×”:',
        noEvents: '××™×Ÿ ××™×¨×•×¢×™×. ××ª×” ×¤× ×•×™!',
        raceStart: '×”×ª×—×œ×ª ××™×¨×•×¥',
        raceEnd: '×¡×™×•× ××™×¨×•×¥',
        totalDriving: '×¡×”"×› × ×”×™×’×”',
        avgStint: '×××•×¦×¢ ×¡×˜×™× ×˜',
        stintCount: '×¡×˜×™× ×˜×™×',
        localhostError: '×¤×™×¦\'×¨ ×–×” ×¢×•×‘×“ ×¨×§ ×‘×©×¨×ª (Netlify) ×•×œ× ××§×•××™×ª.',
        loading: '×˜×•×¢×Ÿ...',
        strategyLoaded: '××¡×˜×¨×˜×’×™×” × ×˜×¢× ×” ×‘×”×¦×œ×—×”!',
        saveSuccess: '× ×©××¨ ×‘×”×¦×œ×—×”',
        scheduleTitle: '×œ×•×— ×–×× ×™×',
        summaryTitle: '×¡×™×›×•× × ×”×’×™×'
    },
    fr: {
        offline: 'Hors ligne',
        subtitle: 'Gestionnaire de StratÃ©gie de Course d\'Endurance',
        host: 'HÃ´te',
        hostDesc: 'GÃ©rer la course',
        viewer: 'Spectateur',
        viewerDesc: 'Regarder en direct',
        yourCode: 'Votre Code:',
        retry: 'RÃ©essayer',
        raceSettings: 'âš™ï¸ ParamÃ¨tres de Course',
        liveTiming: 'ChronomÃ©trage en Direct (Optionnel)',
        liveTimingUrl: 'URL ChronomÃ©trage (APEX/RaceFacer)',
        searchBy: 'Rechercher par:',
        team: 'Ã‰quipe',
        kart: 'Kart',
        driver: 'Pilote',
        testConnection: 'Tester',
        demo: 'DÃ©mo',
        manual: 'Manuel',
        duration: 'DurÃ©e (heures)',
        reqStops: 'ArrÃªts Requis',
        minStint: 'Stint Min (min)',
        maxStint: 'Stint Max (min)',
        driverLimits: 'Limites Pilote (0 = illimitÃ©)',
        minDrive: 'Min Conduite',
        maxDrive: 'Max Conduite',
        pitTime: 'Temps Pit (sec)',
        releaseBuffer: 'Alerte Avance (sec)',
        doubleStint: 'Double',
        fuel: 'Carburant',
        squads: 'Ã‰quipes',
        fuelTankTime: 'Autonomie RÃ©servoir (min)',
        driversSetup: 'Pilotes (marquer le dÃ©part)',
        startRace: 'DÃ©marrer Course (HÃ´te)',
        enterCode: 'Entrer Code HÃ´te:',
        connect: 'Connecter',
        disconnect: 'DÃ©connecter',
        code: 'Code:',
        synced: 'SynchronisÃ©',
        simResultPattern: "âœ… {stints} relais Ã— ~{avg}min = {totalDrive}min conduite\nğŸ ArrÃªts: {stops} Ã— {pitTime}s = {totalPit}min\n{note}",
        stdStrategy: "StratÃ©gie standard - maximiser les relais",
        shortStrategy: "StratÃ©gie courte - minimiser les arrÃªts",
        longStrategy: "StratÃ©gie longue - Ã©conomiser carburant/pneus",
        raceTime: 'Temps Course',
        pitStops: 'ArrÃªts Pit',
        dry: 'Sec',
        wet: 'MouillÃ©',
        drying: 'SÃ©chage',
        targetStint: 'Stint Cible',
        buildTime: 'Accumuler Temps',
        stintTime: 'Temps Stint',
        currentDriver: 'Pilote Actuel',
        activeSquad: 'Ã‰quipe Active:',
        resting: 'Au Repos:',
        push: 'Pousser',
        problem: 'ProblÃ¨me',
        night: 'Nuit',
        resetMode: 'â†©ï¸ RÃ©initialiser',
        driverHeader: 'Pilote',
        stintsHeader: 'St.',
        totalHeader: 'Total',
        nextDriver: 'Prochain Pilote',
        enterPit: 'ğŸ Entrer Pit',
        inPit: 'AU PIT',
        nextDriverIn: 'Prochain Pilote:',
        refuel: 'Changement Kart / Ravitaillement?',
        notifyDriver: 'Alerter Pilote',
        notified: 'AlertÃ© - Attente passage ligne',
        wait: 'Attendre...',
        cancelPit: 'Annuler EntrÃ©e Pit',
        manualInput: 'Saisie Manuelle',
        position: 'Position',
        laps: 'Tours',
        lastLap: 'Dernier Tour',
        bestLap: 'Meilleur Tour',
        gap: 'Ã‰cart au Leader',
        inPitNow: 'Actuellement au Pit',
        apply: 'Appliquer',
        cancel: 'Annuler',
        waitingData: 'En attente de donnÃ©es...',
        proxyData: 'DonnÃ©es Proxy:',
        liveView: 'Vue en Direct',
        connecting: 'Connexion...',
        connected: 'ConnectÃ©',
        waitingRace: 'ConnectÃ©! En attente de la course...',
        disconnected: 'DÃ©connectÃ©',
        enterUrl: 'âŒ Entrer URL',
        enterValue: 'âŒ Entrer',
        testing: 'ğŸ”„ Test...',
        found: 'âœ… TrouvÃ©! Position:',
        notFound: 'âš ï¸ Non trouvÃ© - vÃ©rifier ou utiliser iframe',
        error: 'âŒ Erreur:',
        confirmEarlyPit: 'FenÃªtre fermÃ©e! Entrer quand mÃªme?',
        confirmExit: 'âœ… Confirmer Passage Ligne',
        timeExceeded: 'ğŸš¨ Temps DÃ©passÃ©!',
        problemQuick: 'ğŸ¢ ProblÃ¨me - EntrÃ©e Rapide!',
        pushExtend: 'ğŸ”¥ On prolonge! Accumuler temps',
        nearLimit: 'âš ï¸ Proche limite!',
        targetWindow: 'âœ… FenÃªtre Cible',
        overExtend: 'ğŸ“¥ Prolongation Excessive',
        nightActive: 'ğŸŒ™ Nuit Active',
        pushActive: 'ğŸ”¥ Pousser Actif',
        problemActive: 'ğŸ¢ ProblÃ¨me Actif',
        teamNotFound: 'Ã‰quipe non trouvÃ©e',
        connectionIssues: 'ProblÃ¨mes de connexion',
        usingIframe: 'Utilisation de l\'iframe',
        connectionFailed: 'Ã‰chec de connexion',
        stopped: 'ArrÃªtÃ©',
        racePreview: 'AperÃ§u de la StratÃ©gie',
        raceStartTime: 'Heure de DÃ©part',
        driverSchedule: 'Horaire des Pilotes',
        strategySummary: 'RÃ©sumÃ© de la StratÃ©gie',
        editStrategy: 'Retour Ã  l\'Ã©cran principal',
        saveStrategy: 'Enregistrer la StratÃ©gie',
        previewStrategy: 'AperÃ§u de la StratÃ©gie',
        stopLiveTiming: 'ArrÃªter',
        activeRaceFound: 'Course Active TrouvÃ©e!',
        raceInProgress: 'Une course est actuellement en cours',
        timeRemaining: 'Temps Restant',
        continueRace: 'Continuer la Course',
        discardRace: 'Supprimer et Recommencer',
        raceWarning: 'La suppression effacera dÃ©finitivement les donnÃ©es de course',
        confirmDiscard: 'ÃŠtes-vous SÃ»r?',
        confirmDiscardMessage: 'Cela supprimera dÃ©finitivement la course active. Cette action ne peut pas Ãªtre annulÃ©e.',
        yesDiscard: 'Oui, Supprimer la Course',
        noKeepRace: 'Non, Garder la Course',
        loadStrategy: 'Charger une StratÃ©gie',
        savedStrategies: 'ğŸ“š StratÃ©gies EnregistrÃ©es',
        noSavedStrategies: 'Aucune stratÃ©gie enregistrÃ©e',
        strategyName: 'Nom de la stratÃ©gie:',
        strategySaved: 'âœ… StratÃ©gie enregistrÃ©e:',
        aiAssistant: 'ğŸ¤– Assistant StratÃ©gie IA',
        expectedConditions: 'Conditions PrÃ©vues:',
        mixed: 'Mixte',
        strategyInstructions: 'Instructions:',
        aiPlaceholder: "ex: 'Double relais la nuit pour l'Ã©quipe A', 'Garder pilote X pour la fin'...",
        generateAi: 'ğŸ¤– GÃ©nÃ©rer StratÃ©gie',
        analyzing: 'ğŸ¤– Analyse en cours...',
        aiApplied: 'âœ… StratÃ©gie appliquÃ©e!',
        aiError: 'âŒ Erreur de gÃ©nÃ©ration',
        pitClosedStart: 'ğŸš« Pit FermÃ© DÃ©but (min)',
        pitClosedEnd: 'ğŸš« Pit FermÃ© Fin (min)',
        finish: 'Fin',
        raceFinished: 'ğŸ Course TerminÃ©e!',
        savedToDb: 'âœ… EnregistrÃ© dans la BDD',
        safetyWarning: 'âš ï¸ Avertissement de SÃ©curitÃ©',
        googleConnect: 'Connexion Google',
        signInGoogle: 'Se connecter avec Google',
        emailTeam: 'Envoyer email Ã  l\'Ã©quipe',
        addCalendar: 'Ajouter au calendrier',
        shareStrategy: 'Partager la stratÃ©gie',
        checkAvailability: 'VÃ©rifier disponibilitÃ©',
        recipients: 'Destinataires (sÃ©parÃ©s par virgule)',
        emailSubject: 'Sujet',
        message: 'Message',
        attachStrategy: 'Joindre la stratÃ©gie actuelle',
        sendEmail: 'Envoyer Email',
        addToCalendar: 'Ajouter Ã  Google Agenda',
        eventTitle: 'Titre de l\'Ã©vÃ©nement',
        startDate: 'Date de dÃ©but',
        startTime: 'Heure de dÃ©but',
        location: 'Lieu',
        inviteDrivers: 'Inviter pilotes (emails)',
        addReminder: 'Ajouter rappel (1 jour avant)',
        createEvent: 'CrÃ©er l\'Ã©vÃ©nement',
        recipientsHistory: 'Destinataires rÃ©cents',
        eventsFound: 'Ã‰vÃ©nements trouvÃ©s :',
        noEvents: 'Aucun Ã©vÃ©nement. Vous Ãªtes libre !',
        raceStart: 'DÃ©but de course',
        raceEnd: 'Fin de course',
        totalDriving: 'Temps de conduite total',
        avgStint: 'Stint moyen',
        stintCount: 'Relais',
        localhostError: 'FonctionnalitÃ© serveur (Netlify) requise.',
        loading: 'Chargement...',
        strategyLoaded: 'StratÃ©gie chargÃ©e !',
        saveSuccess: 'EnregistrÃ© avec succÃ¨s',
        scheduleTitle: 'Horaire',
        summaryTitle: 'RÃ©sumÃ© des pilotes'
    },
    pt: {
        offline: 'Offline',
        subtitle: 'Gestor de EstratÃ©gia de Corrida de Endurance',
        host: 'AnfitriÃ£o',
        hostDesc: 'Gerir a corrida',
        viewer: 'Espectador',
        viewerDesc: 'Ver ao vivo',
        yourCode: 'Seu CÃ³digo:',
        retry: 'Tentar Novamente',
        raceSettings: 'âš™ï¸ ConfiguraÃ§Ãµes da Corrida',
        liveTiming: 'Cronometragem ao Vivo (Opcional)',
        liveTimingUrl: 'URL Cronometragem (APEX/RaceFacer)',
        searchBy: 'Pesquisar por:',
        team: 'Equipa',
        kart: 'Kart',
        driver: 'Piloto',
        testConnection: 'Testar',
        demo: 'Demo',
        manual: 'Manual',
        duration: 'DuraÃ§Ã£o (horas)',
        reqStops: 'Paragens ObrigatÃ³rias',
        minStint: 'Stint MÃ­n (min)',
        maxStint: 'Stint MÃ¡x (min)',
        driverLimits: 'Limites Piloto (0 = ilimitado)',
        minDrive: 'MÃ­n ConduÃ§Ã£o',
        maxDrive: 'MÃ¡x ConduÃ§Ã£o',
        pitTime: 'Tempo Pit (seg)',
        releaseBuffer: 'Alerta Antecipado (seg)',
        doubleStint: 'Duplo',
        fuel: 'CombustÃ­vel',
        squads: 'Equipas',
        fuelTankTime: 'Autonomia Tanque (min)',
        driversSetup: 'Pilotos (marcar partida)',
        startRace: 'Iniciar Corrida (AnfitriÃ£o)',
        enterCode: 'Inserir CÃ³digo AnfitriÃ£o:',
        connect: 'Conectar',
        disconnect: 'Desconectar',
        code: 'CÃ³digo:',
        synced: 'Sincronizado',
        simResultPattern: "âœ… {stints} turnos Ã— ~{avg}min = {totalDrive}min conduÃ§Ã£o\nğŸ Paradas: {stops} Ã— {pitTime}s = {totalPit}min\n{note}",
        stdStrategy: "EstratÃ©gia padrÃ£o - maximizar turnos",
        shortStrategy: "EstratÃ©gia curta - minimizar paradas",
        longStrategy: "EstratÃ©gia longa - economizar combustÃ­vel/pneus",
        aiStrategyPrefix: "ğŸ¤– AI Plan: ",
        raceTime: 'Tempo Corrida',
        pitStops: 'Paragens Pit',
        dry: 'Seco',
        wet: 'Molhado',
        drying: 'Secando',
        targetStint: 'Stint Alvo',
        buildTime: 'Acumular Tempo',
        stintTime: 'Tempo Stint',
        currentDriver: 'Piloto Atual',
        activeSquad: 'Equipa Ativa:',
        resting: 'Descansando:',
        push: 'Atacar',
        problem: 'Problema',
        night: 'Noite',
        resetMode: 'â†©ï¸ Reiniciar',
        driverHeader: 'Piloto',
        stintsHeader: 'St.',
        totalHeader: 'Total',
        nextDriver: 'PrÃ³ximo Piloto',
        enterPit: 'ğŸ Entrar Pit',
        inPit: 'NO PIT',
        nextDriverIn: 'PrÃ³ximo Piloto:',
        refuel: 'Troca Kart / Reabastecimento?',
        notifyDriver: 'Alertar Piloto',
        notified: 'Alertado - Aguardando passagem linha',
        wait: 'Aguardar...',
        cancelPit: 'Cancelar Entrada Pit',
        manualInput: 'Entrada Manual',
        position: 'PosiÃ§Ã£o',
        laps: 'Voltas',
        lastLap: 'Ãšltima Volta',
        bestLap: 'Melhor Volta',
        gap: 'DiferenÃ§a ao LÃ­der',
        inPitNow: 'Atualmente no Pit',
        apply: 'Aplicar',
        cancel: 'Cancelar',
        waitingData: 'Aguardando dados...',
        proxyData: 'Dados Proxy:',
        liveView: 'Vista ao Vivo',
        connecting: 'Conectando...',
        connected: 'Conectado',
        waitingRace: 'Conectado! Aguardando corrida...',
        disconnected: 'Desconectado',
        enterUrl: 'âŒ Inserir URL',
        enterValue: 'âŒ Inserir',
        testing: 'ğŸ”„ Testando...',
        found: 'âœ… Encontrado! PosiÃ§Ã£o:',
        notFound: 'âš ï¸ NÃ£o encontrado - verificar ou usar iframe',
        error: 'âŒ Erro:',
        confirmEarlyPit: 'Janela fechada! Entrar mesmo assim?',
        confirmExit: 'âœ… Confirmar Passagem Linha',
        timeExceeded: 'ğŸš¨ Tempo Excedido!',
        problemQuick: 'ğŸ¢ Problema - Entrada RÃ¡pida!',
        pushExtend: 'ğŸ”¥ Prolongando! Acumular tempo',
        nearLimit: 'âš ï¸ Perto do limite!',
        targetWindow: 'âœ… Janela Alvo',
        overExtend: 'ğŸ“¥ Prolongamento Excessivo',
        nightActive: 'ğŸŒ™ Noite Ativa',
        pushActive: 'ğŸ”¥ Atacar Ativo',
        problemActive: 'ğŸ¢ Problema Ativo',
        teamNotFound: 'Equipa nÃ£o encontrada',
        connectionIssues: 'Problemas de conexÃ£o',
        usingIframe: 'Usando iframe',
        connectionFailed: 'ConexÃ£o falhou',
        stopped: 'Parado',
        racePreview: 'VisualizaÃ§Ã£o da EstratÃ©gia de Corrida',
        raceStartTime: 'Hora de InÃ­cio da Corrida',
        driverSchedule: 'HorÃ¡rio dos Pilotos',
        strategySummary: 'Resumo da EstratÃ©gia',
        editStrategy: 'Voltar para tela principal',
        saveStrategy: 'Salvar EstratÃ©gia',
        previewStrategy: 'Visualizar EstratÃ©gia',
        stopLiveTiming: 'Parar',
        activeRaceFound: 'Corrida Ativa Encontrada!',
        raceInProgress: 'Uma corrida estÃ¡ atualmente em andamento',
        timeRemaining: 'Tempo Restante',
        continueRace: 'Continuar Corrida',
        discardRace: 'Descartar e ComeÃ§ar Novo',
        raceWarning: 'Descartar irÃ¡ excluir permanentemente os dados da corrida',
        confirmDiscard: 'Tem Certeza?',
        confirmDiscardMessage: 'Isso excluirÃ¡ permanentemente a corrida ativa. Esta aÃ§Ã£o nÃ£o pode ser desfeita.',
        yesDiscard: 'Sim, Descartar Corrida',
        noKeepRace: 'NÃ£o, Manter Corrida',
        loadStrategy: 'Carregar EstratÃ©gia',
        savedStrategies: 'ğŸ“š EstratÃ©gias Salvas',
        noSavedStrategies: 'Nenhuma estratÃ©gia salva',
        strategyName: 'Nome da EstratÃ©gia:',
        strategySaved: 'âœ… EstratÃ©gia salva:',
        aiAssistant: 'ğŸ¤– Assistente de EstratÃ©gia IA',
        expectedConditions: 'CondiÃ§Ãµes Esperadas:',
        mixed: 'Misto',
        strategyInstructions: 'InstruÃ§Ãµes:',
        aiPlaceholder: "ex: 'Duplo stint Ã  noite para Equipa A', 'Guardar piloto X para o fim'...",
        generateAi: 'ğŸ¤– Gerar EstratÃ©gia',
        analyzing: 'ğŸ¤– Analisando estratÃ©gia...',
        aiApplied: 'âœ… EstratÃ©gia aplicada!',
        aiError: 'âŒ Erro ao gerar',
        pitClosedStart: 'ğŸš« Pit Fechado InÃ­cio (min)',
        pitClosedEnd: 'ğŸš« Pit Fechado Fim (min)',
        finish: 'Fim',
        raceFinished: 'ğŸ Corrida Terminada!',
        savedToDb: 'âœ… Salvo no banco de dados',
        safetyWarning: 'âš ï¸ Aviso de SeguranÃ§a',
        googleConnect: 'ConexÃ£o Google',
        signInGoogle: 'Entrar com Google',
        emailTeam: 'Enviar e-mail para equipe',
        addCalendar: 'Adicionar Ã  Agenda',
        shareStrategy: 'Compartilhar EstratÃ©gia',
        checkAvailability: 'Verificar Disponibilidade',
        recipients: 'DestinatÃ¡rios (separados por vÃ­rgula)',
        emailSubject: 'Assunto',
        message: 'Mensagem',
        attachStrategy: 'Anexar estratÃ©gia atual',
        sendEmail: 'Enviar E-mail',
        addToCalendar: 'Adicionar ao Google Agenda',
        eventTitle: 'TÃ­tulo do Evento',
        startDate: 'Data de InÃ­cio',
        startTime: 'Hora de InÃ­cio',
        location: 'Local',
        inviteDrivers: 'Convidar Pilotos (e-mails)',
        addReminder: 'Adicionar lembrete (1 dia antes)',
        createEvent: 'Criar Evento',
        recipientsHistory: 'DestinatÃ¡rios recentes',
        eventsFound: 'Eventos encontrados:',
        noEvents: 'Nenhum evento. VocÃª estÃ¡ livre!',
        raceStart: 'InÃ­cio da Corrida',
        raceEnd: 'Fim da Corrida',
        totalDriving: 'ConduÃ§Ã£o Total',
        avgStint: 'Stint MÃ©dio',
        stintCount: 'Stints',
        localhostError: 'Recursos do servidor (Netlify) necessÃ¡rios.',
        loading: 'Carregando...',
        strategyLoaded: 'EstratÃ©gia carregada!',
        saveSuccess: 'Salvo com sucesso',
        scheduleTitle: 'HorÃ¡rio',
        summaryTitle: 'Resumo dos Pilotos'
    }
};

window.t = function(key) {
    return window.translations[window.currentLang]?.[key] || window.translations['en'][key] || key;
};

window.tFormat = function(key, replacements) {
    let text = window.t(key);
    for (const [placeholder, value] of Object.entries(replacements)) {
        text = text.replace(`{${placeholder}}`, value);
    }
    return text;
};

window.setLanguage = function(lang) {
    if (!['en', 'he', 'fr', 'pt'].includes(lang)) return;
    
    window.currentLang = lang;
    document.documentElement.lang = window.currentLang;
    document.documentElement.dir = window.currentLang === 'he' ? 'rtl' : 'ltr';
    
    const langSelect = document.getElementById('langSelect');
    if(langSelect) langSelect.value = window.currentLang;
    
    window.applyTranslations();
    localStorage.setItem('strateger_lang', lang);
};

window.applyTranslations = function() {
    document.querySelectorAll('[data-i18n]').forEach(el => {
        const key = el.getAttribute('data-i18n');
        if (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA') {
             el.placeholder = window.t(key);
        } else {
             el.innerText = window.t(key);
        }
    });
    
    window.updateSearchPlaceholder();
    const aiInput = document.getElementById('strategyInstructions');
    if (aiInput) {
        aiInput.placeholder = window.t('aiPlaceholder');
    }
};

window.updateSearchPlaceholder = function() {
    const searchType = document.querySelector('input[name="searchType"]:checked')?.value || 'team';
    const input = document.getElementById('searchValue');
    if (!input) return;
    
    const placeholders = {
        en: { team: 'Enter team name', kart: 'Enter kart number', driver: 'Enter driver name' },
        he: { team: '×”×›× ×¡ ×©× ×§×‘×•×¦×”', kart: '×”×›× ×¡ ××¡×¤×¨ ×§××¨×˜', driver: '×”×›× ×¡ ×©× × ×”×’' },
        fr: { team: 'Nom d\'Ã©quipe', kart: 'NumÃ©ro de kart', driver: 'Nom du pilote' },
        pt: { team: 'Nome da equipa', kart: 'NÃºmero do kart', driver: 'Nome do piloto' }
    };
    
    input.placeholder = placeholders[window.currentLang]?.[searchType] || placeholders.en[searchType];
};